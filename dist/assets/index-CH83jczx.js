(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();function et(a){return Object.fromEntries(Object.entries(a).map(([t,e])=>[t,document.querySelector(e)]))}function p(a){return a==null||isNaN(a)?"–":a.toLocaleString("ru-RU",{maximumFractionDigits:0})}function fe(a){const t=p(a);return t==="–"?t:`${t} ₽`}function _(a){return a==null||isNaN(a)?"–":(a*100).toFixed(1)+" %"}function U(a){return a?new Date(a).toLocaleString("ru-RU"):"—"}function v(a,t={day:"2-digit",month:"long"}){if(!a)return"—";const e=new Date(a);return Number.isNaN(e.getTime())?"—":e.toLocaleDateString("ru-RU",t)}function ge(a,t={maximumFractionDigits:3}){if(a==null||Number.isNaN(a))return"–";const e={minimumFractionDigits:0,...t};return Number(a).toLocaleString("ru-RU",e)}function x(a,t="success"){const e=document.createElement("div");e.className=`toast ${t}`,e.textContent=a,document.body.appendChild(e),setTimeout(()=>{e.style.animation="slideIn 0.3s ease reverse",setTimeout(()=>e.remove(),300)},3e3)}function S(a){if(a.delta_amount!==null&&a.delta_amount!==void 0)return a.delta_amount;const t=a.planned_amount??0;return(a.fact_amount??0)-t}function at(a,t){let e;return(...s)=>{clearTimeout(e),e=setTimeout(()=>a(...s),t)}}function k(a){if(a==null)return null;const t=typeof a=="number"?a:Number(a);return Number.isFinite(t)?t:null}function st(a,t=!0){Object.values(a).forEach(e=>{e&&typeof e.disabled=="boolean"&&(e.disabled=t)})}const nt={внерегл_ч_1:{key:"внерегламент",title:"внерегламент"},внерегл_ч_2:{key:"внерегламент",title:"внерегламент"}};function N(a){const t=k(a);return t!==null&&t!==0}function O(a){return a?N(a.planned_amount)||N(a.fact_amount):!1}function V(a,t){const e=(a||"").trim(),s=nt[e.toLowerCase()];if(s)return{...s};const n=(t||"").trim(),o=e||n||"Прочее";return{key:o,title:n||o}}function W(a=[]){return a.reduce((t,e)=>(e.planned_amount!==null&&e.planned_amount!==void 0&&(t.planned+=e.planned_amount,t.hasPlanned=!0),e.fact_amount!==null&&e.fact_amount!==void 0&&(t.fact+=e.fact_amount,t.hasFact=!0),t),{planned:0,fact:0,hasPlanned:!1,hasFact:!1})}function ot(a){if(!a)return null;const t=a.items||[],e=W(t),s=a.summary||{},n=s.planned_amount??(e.hasPlanned?e.planned:null),o=s.fact_amount??(e.hasFact?e.fact:null),i=s.completion_pct??(n?(o??0)/n:null),u=s.delta_amount!==null&&s.delta_amount!==void 0?s.delta_amount:n!==null||o!==null?(o??0)-(n??0):null,l=Array.isArray(s.daily_revenue)?s.daily_revenue.map(c=>{const h=k((c==null?void 0:c.amount)??(c==null?void 0:c.fact_total)??(c==null?void 0:c.value)),y=(c==null?void 0:c.date)||(c==null?void 0:c.work_date)||(c==null?void 0:c.day);return!y||h===null?null:{date:y,amount:h}}).filter(Boolean):[],d=k(s.average_daily_revenue)??(l.length?l.reduce((c,h)=>c+h.amount,0)/l.length:null);return{planned:n,fact:o,completion:i,delta:u,dailyRevenue:l,averageDailyRevenue:d}}function it(a){if(!a||!a.summary)return null;const t=a.summary,e=k(t.contract_amount),s=k(t.contract_executed),n=t.contract_completion_pct??(e?(s??0)/e:null);return{contractAmount:e,executed:s,completion:n}}function rt(a=[]){const t=new Map;return a.forEach(e=>{if(!O(e))return;const s=e.category||e.smeta||"",n=s?s.trim():"";if(!n||n.toLowerCase()==="без категории")return;const{key:o,title:i}=V(n,e.smeta);t.has(o)||t.set(o,{key:o,title:i,works:[],planned:0,fact:0,delta:0});const r=t.get(o);!r.title&&i&&(r.title=i),e.category_plan_only===!0||r.works.push(e);const l=e.planned_amount??0,d=e.fact_amount??0,c=S(e);isNaN(l)||(r.planned+=l),isNaN(d)||(r.fact+=d),isNaN(c)||(r.delta+=c)}),Array.from(t.values()).sort((e,s)=>{const n=isNaN(e.planned)?0:e.planned,o=isNaN(s.planned)?0:s.planned;if(n===o){const i=(e.title||"").toLowerCase(),r=(s.title||"").toLowerCase();return i.localeCompare(r,"ru")}return o-n})}const b={hasMeaningfulAmount:N,shouldIncludeItem:O,resolveCategoryMeta:V,summarizeItems:W,calculateMetrics:ot,calculateContractMetrics:it,buildCategories:rt};class lt{constructor(){this.viewMode="monthly",this.selectedMonthIso=null,this.selectedDayIso=null,this.availableDays=[]}getViewMode(){return this.viewMode||"monthly"}getSelectedMonth(){return this.selectedMonthIso}getSelectedDay(){return this.selectedDayIso}getAvailableDays(){return Array.isArray(this.availableDays)?this.availableDays:[]}setViewMode(t){this.viewMode=t==="daily"?"daily":"monthly"}setSelectedMonth(t){this.selectedMonthIso=t||null}setSelectedDay(t){this.selectedDayIso=t||null}setAvailableDays(t){this.availableDays=Array.isArray(t)?t:[]}}const dt="/api/dashboard",ct="/pdf",ut="/months",ht="/days",yt="/daily",P=(()=>{const a=document.querySelector('meta[name="mad-api-url"]');return((a==null?void 0:a.content)||window.MAD_API_URL||"").trim()||dt})(),M=P.replace(/\/$/,""),mt=`${M}${ct}`,G=`${M}${ut}`,K=`${M}${ht}`,q=`${M}${yt}`,pt="(max-width: 767px)",ft="Скачать PDF",gt={page:".page",monthSelect:"#month",daySelect:"#day",monthControls:"#month-controls",dayControls:"#day-controls",lastUpdatedText:"#last-updated-text",lastUpdatedTextDaily:"#last-updated-text-daily",sumPlanned:"#sum-planned",sumFact:"#sum-fact",sumDelta:"#sum-delta",sumFactProgress:"#sum-fact-progress",sumFactProgressLabel:"#sum-fact-progress-label",sumDailyAverage:"#sum-daily-average",dailyAverageNote:"#daily-average-note",dailyAverageHint:"#daily-average-hint",dailyAverageCard:"#daily-average-card",dailyModal:"#daily-modal",dailyModalClose:"#daily-modal-close",dailyModalList:"#daily-modal-list",dailyModalEmpty:"#daily-modal-empty",dailyModalSubtitle:"#daily-modal-subtitle",summaryGrid:"#summary-grid",summarySkeleton:"#summary-skeleton",categoryGrid:"#category-grid",categorySkeleton:"#category-skeleton",workList:"#work-list",workSkeleton:"#work-skeleton",workEmptyState:"#work-empty-state",workSortSelect:"#work-sort-select",activeCategoryTitle:"#active-category-title",activeCategoryTitleDesktop:"#active-category-title-desktop",activeCategoryTitleMobileValue:"#active-category-title-mobile-value",workDetailHint:"#work-detail-hint",pdfButton:"#download-pdf",pdfButtonContainerDesktop:".pdf-action-desktop",pdfButtonContainerMobile:".pdf-action-mobile",contractCard:"#contract-card",contractAmount:"#contract-amount",contractExecuted:"#contract-executed",contractPercent:"#contract-percent",contractProgress:"#contract-progress",contractTitleDate:"#contract-title-date",viewModeMonthly:"#tab-monthly",viewModeDaily:"#tab-daily",dailyPanel:"#daily-panel",dailySkeleton:"#daily-skeleton",dailyEmptyState:"#daily-empty-state",dailyTable:"#daily-table",dailyPanelTitle:"#daily-panel-title",dailyPanelSubtitle:"#daily-panel-subtitle"},wt=new Set([408,425,429,500,502,503,504]),D=700;async function vt(a=D){return new Promise(t=>setTimeout(t,a))}function L(a){const t=new Error("HTTP "+a.status);return t.retryable=wt.has(a.status),t}function St(a){if(!a)return!1;if(a.retryable===!0)return!0;if(a.retryable===!1)return!1;const t=(a.message||"").toLowerCase();return a.name==="TypeError"||t.includes("network")||t.includes("timeout")||t.includes("timed out")||t.includes("connection")}async function C(a,{retries:t=1,delayMs:e=D}={}){let s;for(let n=0;n<=t;n+=1)try{return await a()}catch(o){if(s=o,n===t||!St(o))break;await vt(e)}throw s}class Dt{constructor(t=P,{monthsUrl:e=G,daysUrl:s=K,dailyUrl:n=q,visitorTracker:o}={}){this.apiUrl=t,this.monthsUrl=e,this.daysUrl=s,this.dailyUrl=n,this.cache=new Map,this.dailyCache=new Map,this.currentData=null,this.visitorTracker=o||null}getCached(t){return this.cache.get(t)||null}async fetchData(t,{force:e=!1}={}){if(!t)throw new Error("Не указан месяц для загрузки данных дашборда");if(!e&&this.cache.has(t))return{data:this.cache.get(t),fromCache:!0};const s=new URL(this.apiUrl,window.location.origin);s.searchParams.set("month",t),s.searchParams.set("_",Date.now().toString());const n={"Cache-Control":"no-cache",Pragma:"no-cache",...this.visitorTracker?this.visitorTracker.buildHeaders():{}},i=await(await C(()=>fetch(s.toString(),{cache:"no-store",headers:n}).then(r=>{if(!r.ok)throw L(r);return r}),{delayMs:D})).json();return this.cache.set(t,i),{data:i,fromCache:!1}}async fetchAvailableMonths(){const e=await(await C(()=>fetch(this.monthsUrl,{cache:"no-store",headers:this.visitorTracker?this.visitorTracker.buildHeaders():void 0}).then(s=>{if(!s.ok)throw L(s);return s}),{delayMs:D})).json();return Array.isArray(e==null?void 0:e.months)?e.months:[]}async fetchAvailableDays(){const e=await(await C(()=>fetch(this.daysUrl,{cache:"no-store",headers:this.visitorTracker?this.visitorTracker.buildHeaders():void 0}).then(s=>{if(!s.ok)throw L(s);return s}),{delayMs:D})).json();return Array.isArray(e==null?void 0:e.days)?e.days:[]}getCachedDaily(t){return this.dailyCache.get(t)||null}async fetchDailyReport(t,{force:e=!1}={}){if(!t)throw new Error("Не указана дата для загрузки дневного отчёта");if(!e&&this.dailyCache.has(t))return{data:this.dailyCache.get(t),fromCache:!0};const s=new URL(this.dailyUrl,window.location.origin);s.searchParams.set("day",t),s.searchParams.set("_",Date.now().toString());const n={"Cache-Control":"no-cache",Pragma:"no-cache",...this.visitorTracker?this.visitorTracker.buildHeaders():{}},i=await(await C(()=>fetch(s.toString(),{cache:"no-store",headers:n}).then(r=>{if(!r.ok)throw L(r);return r}),{delayMs:D})).json();return this.dailyCache.set(t,i),{data:i,fromCache:!1}}setCurrentData(t){this.currentData=t}getCurrentData(){return this.currentData}summarizeItems(t=[]){return b.summarizeItems(t)}calculateMetrics(t){return b.calculateMetrics(t)}calculateContractMetrics(t){return b.calculateContractMetrics(t)}buildCategories(t=[]){return b.buildCategories(t)}}function F(){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();const a=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function A(a,t){try{return a.getItem(t)}catch(e){return console.warn("Не удалось прочитать из хранилища",t,e),null}}function E(a,t,e){try{a.setItem(t,e)}catch(s){console.warn("Не удалось сохранить в хранилище",t,s)}}function $(a,t,{days:e=365}={}){try{const s=Math.max(1,Math.floor(e*24*60*60));document.cookie=`${a}=${encodeURIComponent(t)}; path=/; max-age=${s}`}catch(s){console.warn("Не удалось сохранить cookie",a,s)}}class kt{constructor({userKey:t="mad_user_id",sessionKey:e="mad_session_id",sessionStartedAtKey:s="mad_session_started_at",visitLoggedKey:n="mad_visit_logged"}={}){this.userKey=t,this.sessionKey=e,this.sessionStartedAtKey=s,this.visitLoggedKey=n,this.userId=this.restoreUserId(),this.sessionId=this.restoreSessionId(),this.sessionStartedAt=this.restoreSessionStart(),this.visitLogged=this.restoreVisitLogged()}restoreUserId(){const e=(A(localStorage,this.userKey)||this.getCookieValue(this.userKey)||F()).trim();return E(localStorage,this.userKey,e),$(this.userKey,e,{days:365}),e}restoreSessionId(){const e=(A(sessionStorage,this.sessionKey)||this.getCookieValue(this.sessionKey)||F()).trim();return E(sessionStorage,this.sessionKey,e),$(this.sessionKey,e,{days:1}),e}restoreSessionStart(){const e=k(A(sessionStorage,this.sessionStartedAtKey))??Date.now();return E(sessionStorage,this.sessionStartedAtKey,String(e)),e}restoreVisitLogged(){return A(sessionStorage,this.visitLoggedKey)==="1"}getCookieValue(t){const e=document.cookie.match(new RegExp(`(?:^|; )${t}=([^;]*)`));return e?decodeURIComponent(e[1]):null}getSessionDurationSec(){const t=Date.now()-this.sessionStartedAt;return t>0?Math.round(t/1e3):0}buildHeaders(){const t={};this.userId&&(t["X-User-Id"]=this.userId),this.sessionId&&(t["X-Session-Id"]=this.sessionId);const e=this.getSessionDurationSec();return Number.isFinite(e)&&(t["X-Session-Duration-Sec"]=String(e)),t}markVisitLogged(){this.visitLogged=!0,E(sessionStorage,this.visitLoggedKey,"1")}async sendVisitLog({apiBase:t,endpoint:e}){if(!t||!e||this.visitLogged)return;const s={endpoint:e,user_id:this.userId,session_id:this.sessionId,session_duration_sec:this.getSessionDurationSec()};try{const n=(t||"").replace(/\/$/,"")||"/api";await fetch(`${n}/visit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),keepalive:!0}),this.markVisitLogged()}catch(n){console.warn("Не удалось отправить статистику визита",n)}}logInitialVisit({apiBase:t,endpoint:e}={}){this.sendVisitLog({apiBase:t,endpoint:e})}}const Mt="modulepreload",bt=function(a){return"/"+a},I={},H=function(t,e,s){let n=Promise.resolve();if(e&&e.length>0){let i=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(c=>({status:"fulfilled",value:c}),c=>({status:"rejected",reason:c}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),u=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));n=i(e.map(l=>{if(l=bt(l),l in I)return;I[l]=!0;const d=l.endsWith(".css"),c=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${c}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Mt,d||(h.as="script"),h.crossOrigin="",h.href=l,u&&h.setAttribute("nonce",u),document.head.appendChild(h),d)return new Promise((y,m)=>{h.addEventListener("load",y),h.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return n.then(i=>{for(const r of i||[])r.status==="rejected"&&o(r.reason);return t().catch(o)})},z=115,Y=120,j="#16a34a",Lt="var(--accent)",Ct=78,At=43,Et=47;function _t({metrics:a,elements:t}){if(!a)return t.sumPlanned&&(t.sumPlanned.textContent="–"),t.sumFact&&(t.sumFact.textContent="–"),t.sumDelta&&(t.sumDelta.textContent="–",t.sumDelta.classList.remove("positive","negative")),{summaryDailyRevenue:[],averageDailyRevenue:null,completion:null,completionLabel:"–"};const e=Array.isArray(a.dailyRevenue)?a.dailyRevenue:[];t.sumPlanned&&(t.sumPlanned.textContent=p(a.planned)),t.sumFact&&(t.sumFact.textContent=p(a.fact)),t.sumDelta&&(t.sumDelta.textContent=p(a.delta),t.sumDelta.classList.remove("positive","negative"),a.delta>0&&t.sumDelta.classList.add("positive"),a.delta<0&&t.sumDelta.classList.add("negative"));const s=a.completion!==null&&a.completion!==void 0?_(a.completion):"–";return{summaryDailyRevenue:e,averageDailyRevenue:a.averageDailyRevenue,completion:a.completion,completionLabel:s}}function Pt({completion:a,label:t,elements:e}){const s=a!=null&&!Number.isNaN(a)?Math.max(0,a*100):0,n=Math.min(z,s),o=Math.min(Y,Math.max(0,s)),i=s>100?j:`hsl(${o}, ${Ct}%, ${s>=50?At:Et}%)`;e.sumFactProgress&&(e.sumFactProgress.style.width=`${n}%`,e.sumFactProgress.classList.toggle("overflow",s>100),e.sumFactProgress.style.setProperty("--progress-color",i)),e.sumFactProgressLabel&&(e.sumFactProgressLabel.textContent=t)}function Rt({averageValue:a,daysWithData:t,isCurrentMonth:e,elements:s}){const o=Number.isFinite(t)&&t>0&&e;if(s.sumDailyAverage&&(s.sumDailyAverage.textContent=a!=null&&!Number.isNaN(a)?p(a):"–"),s.dailyAverageCard){s.dailyAverageCard.classList.toggle("is-disabled",!o),s.dailyAverageCard.setAttribute("aria-disabled",String(!o));const i=s.dailyAverageCard.querySelector(".sr-only");i&&(i.hidden=!o)}}function Tt({contractMetrics:a,elements:t,formatMoneyFn:e=p,formatPercentFn:s=_}){if(!t.contractCard)return;const n=a&&a.contractAmount!==null&&a.executed!==null,o=n?a.completion:null,i=o!=null&&!Number.isNaN(o)?s(o):"–";t.contractAmount&&(t.contractAmount.textContent=n?e(a.contractAmount):"–"),t.contractExecuted&&(t.contractExecuted.textContent=n?e(a.executed):"–"),t.contractPercent&&(t.contractPercent.textContent=i),X({completion:o,elements:t})}function X({completion:a,elements:t}){if(!t.contractProgress)return;const e=a!=null&&!Number.isNaN(a)?Math.max(0,a*100):0,s=Math.min(z,e),n=e>100,o=n?j:Lt;t.contractProgress.style.width=`${s}%`,t.contractProgress.style.setProperty("--progress-color",o),t.contractProgress.style.background=o,t.contractProgress.classList.toggle("overflow",n),t.contractProgress.parentElement&&t.contractProgress.parentElement.setAttribute("aria-valuenow",Math.min(Y,e).toFixed(1))}function Nt(a){return _t(a)}function Ut(a){return Pt(a)}function xt(a){return Rt(a)}function Ft(a){return Tt(a)}function $t(a){return X(a)}const It=115,B=120,Ht="#16a34a",Bt=78,Ot=43,Vt=47;function Wt({groupedCategories:a,activeCategoryKey:t,elements:e,colors:s,onSelect:n}){if(e.categoryGrid.innerHTML="",!a.length){const i="Нет данных для отображения";e.categoryGrid.innerHTML=`<div class="empty-state">${i}</div>`,n&&n(null);return}const o=document.createDocumentFragment();a.forEach((i,r)=>{const u=s[r%s.length],l=document.createElement("button");l.type="button",l.className=`card card--interactive category-card${i.key===t?" active":""}`,l.style.setProperty("--accent",u.accent),l.style.setProperty("--accent-soft",u.soft);const d=typeof i.key=="string"&&i.key.toLowerCase()==="внерегламент",c=i.delta>0?"delta-positive":i.delta<0?"delta-negative":"",h=i.planned?(i.fact??0)/i.planned:null,y=h!==null&&!Number.isNaN(h)&&Number.isFinite(h),m=y?_(h):"–",f=y?Math.max(0,h*100):0,g=Math.min(It,f),w=f>100?" overflow":"",R=Math.min(B,Math.max(0,f)),T=f>100?Ht:`hsl(${R}, ${Bt}%, ${f>=50?Ot:Vt}%)`,J=`width: ${g}%; --progress-color: ${T};`,Z=y?Math.min(B,f).toFixed(1):"0",tt=d?'<span class="category-offplan-note"><span>30% от</span><span>общего плана</span></span>':`<span class="category-pill">${i.works.length} работ</span>`;l.innerHTML=`
        <div class="category-title">
          <span>${i.title}</span>
          ${tt}
        </div>
        <div class="category-values">
          <span><span class="label">План</span><strong>${p(i.planned)}</strong></span>
          <span><span class="label">Факт</span><strong>${p(i.fact)}</strong></span>
          <span><span class="label">Отклонение</span><strong class="category-delta ${c}">${p(i.delta)}</strong></span>
        </div>
        <div class="category-progress">
          <div class="category-progress-labels">
            <span>Исполнение плана</span>
            <strong>${m}</strong>
          </div>
          <div class="category-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="120" aria-valuenow="${Z}">
            <div class="category-progress-fill${w}" style="${J}"></div>
          </div>
        </div>
      `,l.setAttribute("aria-pressed",i.key===t?"true":"false"),l.addEventListener("click",()=>{n&&n(i.key)}),o.appendChild(l)}),e.categoryGrid.appendChild(o)}function Gt({groupedCategories:a,activeCategoryKey:t,elements:e,colors:s,onSelect:n}){Wt({groupedCategories:a,activeCategoryKey:t,elements:e,colors:s,onSelect:n})}const Kt=[{accent:"#22c55e",soft:"rgba(34, 197, 94, 0.25)"},{accent:"#2563eb",soft:"rgba(37, 99, 235, 0.25)"},{accent:"#f97316",soft:"rgba(249, 115, 22, 0.25)"},{accent:"#dc2626",soft:"rgba(220, 38, 38, 0.25)"},{accent:"#a855f7",soft:"rgba(168, 85, 247, 0.25)"},{accent:"#0f766e",soft:"rgba(15, 118, 110, 0.25)"}];function qt({groupedCategories:a,activeCategoryKey:t,elements:e,onSelect:s}){Gt({groupedCategories:a,activeCategoryKey:t,elements:e,colors:Kt,onSelect:s})}function zt({container:a,onSortChange:t,onWorkClick:e}){const s=document.createElement("div");s.className="work-row work-row-header",s.innerHTML=`
      <div>Работа</div>
      <div>
        <button type="button" class="work-sort-button" data-sort="planned">
          <span>План, ₽</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по плану (по убыванию)</span>
        </button>
      </div>
      <div>
        <button type="button" class="work-sort-button" data-sort="fact">
          <span>Факт, ₽</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по факту (по убыванию)</span>
        </button>
      </div>
      <div>
        <button type="button" class="work-sort-button" data-sort="delta">
          <span>Отклонение</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по отклонению (по убыванию)</span>
        </button>
      </div>
    `,s.hidden=!0,a.appendChild(s);const n=document.createElement("div");n.className="work-list-scroller",n.style.display="none",a.appendChild(n);const o=Array.from(s.querySelectorAll(".work-sort-button"));return o.forEach(i=>{i.addEventListener("click",()=>{const r=i.dataset.sort;t&&t(r)})}),{headerEl:s,scroller:n,sortButtons:o}}function Yt({scroller:a,works:t,onWorkClick:e,initializeNameToggle:s,calculateDeltaFn:n=S}){if(!a||(a.innerHTML="",!Array.isArray(t)||!t.length))return;const o=document.createDocumentFragment();t.forEach((i,r)=>{const u=jt(i,r,t.length,n,e,s);u&&o.appendChild(u)}),a.appendChild(o)}function jt(a,t,e,s,n,o){const i=a.work_name||a.description||"Без названия",r=s(a),u=r>0?"delta-positive":r<0?"delta-negative":"",l=p(a.planned_amount),d=p(a.fact_amount),c=p(r),h=document.createElement("div");return h.className="work-row",t===e-1&&h.classList.add("work-row-last"),h.innerHTML=`
      <div class="work-row-name work-row-name--collapsed" data-expanded="false">
        <span class="work-row-name-text">${i}</span>
        <button
          type="button"
          class="work-row-name-toggle"
          aria-expanded="false"
          aria-label="Развернуть полное название"
        >
          <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
        </button>
      </div>
      <div class="work-row-money work-row-plan">
        <span class="work-row-label">План</span>
        <span>${l}</span>
      </div>
      <div class="work-row-money work-row-fact">
        <span class="work-row-label">Факт</span>
        <span>${d}</span>
      </div>
      <div class="work-row-delta ${u}">
        <span class="work-row-label">Отклонение</span>
        <span class="work-row-delta-value">${c}</span>
      </div>
    `,o&&o(h.querySelector(".work-row-name")),h.addEventListener("click",y=>{y.target.closest(".work-row-name-toggle")||n&&n(a,y)}),h}function Xt({container:a,onSortChange:t,onWorkClick:e,initializeNameToggle:s}){return zt({container:a,onSortChange:t,onWorkClick:e})}function Qt({scroller:a,works:t,onWorkClick:e,initializeNameToggle:s}){Yt({scroller:a,works:t,onWorkClick:e,initializeNameToggle:s,calculateDeltaFn:n=>S(n)})}function Jt({elements:a,summaryDailyRevenue:t,selectedMonthLabel:e,isCurrentMonth:s}){if(!t.length||!a.dailyModal||!s)return;const n=a.dailyModal.querySelector("#daily-modal-title")||document.getElementById("daily-modal-title");n&&(n.textContent="Среднедневная выручка");const o=e||"выбранный месяц";a.dailyModalSubtitle&&(a.dailyModalSubtitle.textContent=`По дням за ${o.toLowerCase()}`),a.dailyModal.classList.add("visible"),a.dailyModal.setAttribute("aria-hidden","false")}function Zt({elements:a,workName:t}){if(!a.dailyModal||!t)return;const e=a.dailyModal.querySelector("#daily-modal-title")||document.getElementById("daily-modal-title");e&&(e.textContent=`Расшифровка: ${t}`),a.dailyModalSubtitle&&(a.dailyModalSubtitle.textContent=""),a.dailyModal.classList.add("visible"),a.dailyModal.setAttribute("aria-hidden","false")}function te({elements:a}){a.dailyModal&&(a.dailyModal.classList.remove("visible"),a.dailyModal.setAttribute("aria-hidden","true"))}function ee({elements:a,dailyRevenue:t,dailyModalMode:e,selectedMonthLabel:s}){if(!a.dailyModalList||!a.dailyModalEmpty)return;const n=s||"выбранный месяц";a.dailyModalSubtitle&&(a.dailyModalSubtitle.textContent=`По дням за ${n.toLowerCase()}`),a.dailyModalList.innerHTML="";const o=[...t].sort((l,d)=>new Date(l.date)-new Date(d.date));if(!o.length){a.dailyModalEmpty.style.display="block",a.dailyModalList.style.display="none";return}a.dailyModalEmpty.style.display="none",a.dailyModalList.style.display="grid";const i=e==="work"||o.some(l=>l.unit||l.total_amount!==null&&l.total_amount!==void 0),r=document.createElement("div");r.className="modal-row modal-row-header",i?r.innerHTML=`
      <div class="modal-row-date">Дата</div>
      <div class="modal-row-value"><span class="modal-value-number">Объем</span></div>
      <div class="modal-row-sum">Сумма,₽</div>
    `:r.innerHTML=`
      <div class="modal-row-date">Дата</div>
      <div class="modal-row-sum">Сумма, ₽</div>
    `,a.dailyModalList.appendChild(r);const u=document.createDocumentFragment();o.forEach(l=>{const d=document.createElement("div");d.className="modal-row";const h=(typeof window<"u"&&window.matchMedia?window.matchMedia("(max-width: 767px)").matches:!1)?v(l.date,{day:"2-digit",month:"2-digit"}):v(l.date);if(i){const y=Number(l.amount),m=Number.isFinite(y)?y.toFixed(1):"–",f=l.unit||"",g=Number(l.total_amount),w=Number.isFinite(g)?g.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}):"–";d.innerHTML=`
        <div class="modal-row-date">${h}</div>
        <div class="modal-row-value">
          <span class="modal-value-number">${m}</span>
          ${f?`<span class="modal-value-unit">(${f})</span>`:""}
        </div>
        <div class="modal-row-sum">${w}</div>
      `}else{const y=Number(l.amount),m=Number.isFinite(y)?y.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}):"–";d.innerHTML=`
        <div class="modal-row-date">${h}</div>
        <div class="modal-row-sum">${m}</div>
      `}u.appendChild(d)}),a.dailyModalList.appendChild(u)}function ae({elements:a,setLastUpdated:t}){!a.dailySkeleton||!a.dailyTable||!a.dailyEmptyState||(a.dailySkeleton.style.display="block",a.dailyTable.style.display="none",a.dailyEmptyState.style.display="none",t({label:"Загрузка данных…",dateLabel:""}))}function Q({elements:a,message:t}){!a.dailyEmptyState||!a.dailyTable||(a.dailyEmptyState.textContent=t,a.dailyEmptyState.style.display="block",a.dailyTable.style.display="none")}function se({elements:a,message:t="Ошибка загрузки данных",setLastUpdated:e,updateLastUpdatedPills:s}){a.dailySkeleton&&(a.dailySkeleton.style.display="none"),Q({elements:a,message:t}),e({label:t,dateLabel:""}),s()}function ne({data:a,elements:t,formatDateTime:e,formatDate:s,updateLastUpdatedPills:n,updateDailyNameCollapsers:o}){return{apply:({applyFn:r})=>{try{r({data:a,elements:t,onAfterRender:()=>{const u=a==null?void 0:a.has_data,l=u?e(a.last_updated):"Нет данных",d=u?s(a.last_updated,{day:"2-digit",month:"2-digit",year:"numeric"}):l;n({label:l,dateLabel:d}),requestAnimationFrame(()=>o())}})}catch(u){console.error("Ошибка при применении дневных данных:",u)}}}}function oe({elements:a,summaryDailyRevenue:t,selectedMonthLabel:e,isCurrentMonth:s}){!t.length||!s||Jt({elements:a,summaryDailyRevenue:t,selectedMonthLabel:e,isCurrentMonth:s})}function ie({elements:a,item:t,selectedMonthIso:e,dataManager:s,visitorTracker:n,setDailyModalState:o}){if(!t||!a.dailyModal)return Promise.resolve();const i=(t.work_name||t.description||"").toString(),r=e,u=s&&s.apiUrl?s.apiUrl.replace(/\/$/,""):"/api/dashboard",l=new URL(`${u}/work-breakdown`,window.location.origin);return l.searchParams.set("month",r),l.searchParams.set("work",i),(async()=>{Zt({elements:a,workName:i});const d=await fetch(l.toString(),{headers:n?n.buildHeaders():{}});if(!d.ok)throw new Error("HTTP "+d.status);const c=await d.json(),y=((Array.isArray(c)?c:(c==null?void 0:c.daily)||[])||[]).map(m=>{const f=m.date||m.work_date||m.day,g=m.amount??m.total_volume??m.value,w=g==null?null:Number(g),R=m.unit||"",T=m.total_amount??null;return!f||w===null||!Number.isFinite(w)?null:{date:f,amount:w,unit:R,total_amount:T}}).filter(Boolean);return o({mode:"work",dailyRevenue:y}),y})()}function re({elements:a}){te({elements:a})}function le({elements:a,dailyRevenue:t,dailyModalMode:e,selectedMonthLabel:s}){ee({elements:a,dailyRevenue:t,dailyModalMode:e,selectedMonthLabel:s})}function de(a){return v(a,{day:"2-digit",month:"long"})}class ce{constructor({dataManager:t,elements:e,apiPdfUrl:s,pdfButtonDefaultLabel:n,visitorTracker:o}){this.uiStore=new lt,this.dataManager=t,this.elements=e,this.apiPdfUrl=s,this.pdfButtonDefaultLabel=n,this.visitorTracker=o||null,this.groupedCategories=[],this.activeCategoryKey=null,this.workHeaderEl=null,this.liveRegion=null,this.metrics=null,this.lastUpdatedMonthlyLabel=null,this.lastUpdatedMonthlyDateLabel=null,this.lastUpdatedDailyLabel=null,this.lastUpdatedDailyDateLabel=null,this.summaryDailyRevenue=[],this.dailyRevenue=[],this.workSort={column:"planned"},this.initialMonth=new URLSearchParams(window.location.search).get("month"),this.uiStore.setViewMode("monthly"),this.dayOptionsLoaded=!1,this.currentDailyData=null,this.elements.workSortSelect&&(this.elements.workSortSelect.value=this.workSort.column),this.handleResize=at(()=>{this.updateWorkNameCollapsers(),this.updateDailyNameCollapsers()},150),this.monthOptionsLoaded=!1,this.dailyModule=null,this.pdfModule=null}setActiveCategoryTitle(t,e=t){this.elements.activeCategoryTitleDesktop?this.elements.activeCategoryTitleDesktop.textContent=t:this.elements.activeCategoryTitle&&(this.elements.activeCategoryTitle.textContent=t),this.elements.activeCategoryTitleMobileValue&&(this.elements.activeCategoryTitleMobileValue.textContent=e)}init(){this.prepareWorkList(),this.liveRegion=this.createLiveRegion(),this.bindEvents(),this.elements.workDetailHint&&(this.elements.workDetailHint.hidden=!0),this.updateViewModeLayout(),this.initMonthSelect(),window.addEventListener("resize",this.handleResize)}toggleSkeletons(t){this.elements.summarySkeleton&&(this.elements.summarySkeleton.style.display=t?"grid":"none"),this.elements.categorySkeleton&&(this.elements.categorySkeleton.style.display=t?"grid":"none"),this.elements.workSkeleton&&(this.elements.workSkeleton.style.display=t?"block":"none"),this.elements.summaryGrid&&(this.elements.summaryGrid.hidden=t),this.elements.categoryGrid&&(this.elements.categoryGrid.style.display=t?"none":""),this.elements.workList&&(this.elements.workList.style.display=t?"none":"")}updateViewModeLayout(){const t=this.uiStore.getViewMode();this.elements.page&&(this.elements.page.dataset.viewMode=t),this.elements.viewModeMonthly&&(this.elements.viewModeMonthly.classList.toggle("is-active",t==="monthly"),this.elements.viewModeMonthly.setAttribute("aria-selected",t==="monthly"?"true":"false")),this.elements.viewModeDaily&&(this.elements.viewModeDaily.classList.toggle("is-active",t==="daily"),this.elements.viewModeDaily.setAttribute("aria-selected",t==="daily"?"true":"false"));const e=t==="daily";this.elements.pdfButton&&(this.elements.pdfButton.disabled=e||!this.groupedCategories.length),this.updateLastUpdatedPills()}prepareWorkList(){const{headerEl:t,scroller:e,sortButtons:s}=Xt({container:this.elements.workList,onSortChange:n=>this.handleWorkSortChange(n),onWorkClick:(n,o)=>{o&&o.target.closest(".work-row-name-toggle")||this.openWorkModal(n)},initializeNameToggle:n=>this.initializeNameToggle(n)});this.workHeaderEl=t,this.elements.workListScroller=e,this.workSortButtons=s,this.updateWorkSortButtons()}clearWorkRows(){this.elements.workListScroller&&(this.elements.workListScroller.innerHTML="")}renderWorkRows(t){Qt({scroller:this.elements.workListScroller,works:t,onWorkClick:(e,s)=>{s&&s.target.closest(".work-row-name-toggle")||this.openWorkModal(e)},initializeNameToggle:e=>this.initializeNameToggle(e)}),requestAnimationFrame(()=>this.updateWorkNameCollapsers())}bindEvents(){this.elements.workSortSelect&&this.elements.workSortSelect.addEventListener("change",t=>{const e=t.target.value;this.handleWorkSortChange(e)}),this.elements.pdfButton.addEventListener("click",t=>this.downloadPdfReport(t)),this.elements.dailyAverageCard&&this.elements.dailyAverageCard.addEventListener("click",()=>this.openDailyModal()),this.elements.dailyModalClose&&this.elements.dailyModalClose.addEventListener("click",()=>this.closeDailyModal()),this.elements.dailyModal&&this.elements.dailyModal.addEventListener("click",t=>{t.target===this.elements.dailyModal&&this.closeDailyModal()}),this.elements.viewModeMonthly&&this.elements.viewModeMonthly.addEventListener("click",()=>this.switchViewMode("monthly")),this.elements.viewModeDaily&&this.elements.viewModeDaily.addEventListener("click",()=>this.switchViewMode("daily")),this.elements.daySelect&&this.elements.daySelect.addEventListener("change",()=>{this.loadDailyData(this.elements.daySelect.value)})}async loadDailyModule(){return this.dailyModule?this.dailyModule:(this.dailyModule=await H(()=>import("./daily-report-8EcpRqEY.js"),[]),this.dailyModule)}async loadPdfModule(){return this.pdfModule?this.pdfModule:(this.pdfModule=await H(()=>import("./pdf-client-Dffv0c-7.js"),[]).catch(()=>null),this.pdfModule)}async initMonthSelect(){if(!this.elements.monthSelect)return;const t=this.elements.monthSelect;t.innerHTML="",t.disabled=!0;try{const s=(await this.dataManager.fetchAvailableMonths()||[]).map(o=>{if(!o)return null;const i=new Date(o);return Number.isNaN(i.getTime())?null:{iso:o,label:i.toLocaleDateString("ru-RU",{month:"long",year:"numeric"})}}).filter(Boolean);if(!s.length){const o=this.initialMonth||this.getCurrentMonthIso();this.setMonthSelectPlaceholder("Нет данных"),o?await this.loadMonthData(o):this.handleLoadError();return}const n=this.initialMonth&&s.some(o=>o.iso===this.initialMonth);s.forEach((o,i)=>{const r=document.createElement("option");r.value=o.iso,r.textContent=o.label,(n&&o.iso===this.initialMonth||!n&&i===0)&&(r.selected=!0),t.appendChild(r)}),this.monthOptionsLoaded||(t.addEventListener("change",()=>{this.loadMonthData(t.value)}),this.monthOptionsLoaded=!0),t.disabled=!1,this.loadMonthData(t.value||s[0].iso)}catch(e){console.error("Не удалось загрузить список месяцев",e),this.setMonthSelectPlaceholder("Ошибка загрузки"),this.handleLoadError()}}async initDaySelect(){var e;if(!this.elements.daySelect)return;const t=this.elements.daySelect;t.value="",t.disabled=!0,t.min="",t.max="",this.uiStore.setSelectedDay(null);try{const n=(await this.dataManager.fetchAvailableDays()||[]).map(d=>{const c=new Date(d);return Number.isNaN(c.getTime())?null:{iso:c.toISOString().slice(0,10),label:v(c,{day:"2-digit",month:"long"})}}).filter(Boolean).sort((d,c)=>d.iso<c.iso?1:-1);if(this.uiStore.setAvailableDays(n),!n.length){const d=this.getCurrentDayIso(),c=d?[{iso:d,label:v(d,{day:"2-digit",month:"long"})}]:[];this.uiStore.setAvailableDays(c)}const o=this.uiStore.getAvailableDays(),i=o.reduce((d,c)=>!d||c.iso<d?c.iso:d,null),r=o.reduce((d,c)=>!d||c.iso>d?c.iso:d,null);i&&(t.min=i),r&&(t.max=r);const u=this.uiStore.getSelectedDay(),l=u&&o.some(d=>d.iso===u)?u:(e=o[0])==null?void 0:e.iso;l&&(t.value=l,this.uiStore.setSelectedDay(l)),this.dayOptionsLoaded=!0,t.disabled=!1}catch(s){console.error("Не удалось загрузить список дней",s),t.value="",t.placeholder="Ошибка загрузки",t.setAttribute("aria-invalid","true"),this.dayOptionsLoaded=!1}}getCurrentMonthIso(){const t=new Date,e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0");return`${e}-${s}-01`}getCurrentDayIso(){const t=new Date,e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}-${s}-${n}`}getMonthKey(t){if(!t)return null;const e=/^(\d{4})-(\d{1,2})/.exec(t);if(e){const s=Number(e[1]),n=Number(e[2]);if(!Number.isNaN(s)&&n>=1&&n<=12)return`${s}-${n-1}`}return null}isCurrentMonth(t){const e=this.getMonthKey(t);if(!e)return!1;const s=new Date,n=`${s.getFullYear()}-${s.getMonth()}`;return e===n}async switchViewMode(t){var s;const e=t==="daily"?"daily":"monthly";if(this.uiStore.getViewMode()!==e)if(this.uiStore.setViewMode(e),this.updateViewModeLayout(),e==="daily"){this.dayOptionsLoaded||await this.initDaySelect();const n=this.uiStore.getAvailableDays(),o=((s=this.elements.daySelect)==null?void 0:s.value)||this.uiStore.getSelectedDay()||(n[0]?n[0].iso:null)||this.getCurrentDayIso();o?(this.setDaySelectValue(o),await this.loadDailyData(o)):this.showDailyEmptyState("Нет данных за текущий месяц")}else this.updateLastUpdatedPills()}async loadDailyData(t){if(t){this.uiStore.setSelectedDay(t),this.elements.dailySkeleton&&(this.elements.dailySkeleton.style.display="block");try{const{applyDailyData:e}=await this.loadDailyModule(),{data:s}=await this.dataManager.fetchDailyReport(t,{force:!0});this.currentDailyData=s,e({data:s,elements:this.elements,onAfterRender:()=>this.updateDailyNameCollapsers()})}catch(e){console.error("Не удалось загрузить дневной отчёт",e),this.elements.dailyEmptyState&&(this.elements.dailyEmptyState.textContent="Ошибка загрузки данных",this.elements.dailyEmptyState.style.display="block")}finally{this.elements.dailySkeleton&&(this.elements.dailySkeleton.style.display="none")}}}async downloadPdfReport(t){if(!this.elements.pdfButton||this.elements.pdfButton.disabled)return;t.preventDefault();const e=this.elements.pdfButton,s=e.innerHTML;e.disabled=!0,e.innerHTML="Скачивание…";try{const n=await this.loadPdfModule();if(n&&typeof n.downloadPdf=="function")await n.downloadPdf({apiPdfUrl:this.apiPdfUrl,selectedMonthIso:this.uiStore.getSelectedMonth()});else{const o=new URL(this.apiPdfUrl,window.location.origin),i=this.uiStore.getSelectedMonth();i&&o.searchParams.set("month",i),window.open(o.toString(),"_blank")}}catch(n){console.error("Не удалось скачать PDF",n)}finally{e.disabled=!1,e.innerHTML=s}}updateDailyAverageVisibility(t=this.uiStore.getSelectedMonth()){const e=this.isCurrentMonth(t);this.elements.dailyAverageNote&&(this.elements.dailyAverageNote.hidden=!e),this.elements.dailyAverageHint&&(this.elements.dailyAverageHint.hidden=!e),this.elements.workDetailHint&&(this.elements.workDetailHint.hidden=!e)}setMonthSelectPlaceholder(t){if(!this.elements.monthSelect)return;const e=document.createElement("option");e.value="",e.textContent=t,e.disabled=!0,e.selected=!0,this.elements.monthSelect.appendChild(e),this.elements.monthSelect.disabled=!0}async loadMonthData(t){this.uiStore.setSelectedMonth(t),this.selectedMonthIso=t,this.updateDailyAverageVisibility(t);const e=this.dataManager.getCached(t);e?this.applyData(e):this.showLoadingState();try{const{data:s}=await this.dataManager.fetchData(t,{force:!!e});this.applyData(s),this.announce(`Данные за ${this.getSelectedMonthLabel()||"выбранный месяц"} обновлены.`)}catch(s){console.error(s),e?this.announce("Не удалось обновить данные"):this.handleLoadError()}}showLoadingState(){this.groupedCategories=[],this.activeCategoryKey=null,this.summaryDailyRevenue=[],this.dailyRevenue=[],this.toggleSkeletons(!0),this.elements.categoryGrid.innerHTML="",this.lastUpdatedMonthlyLabel="Загрузка данных…",this.lastUpdatedMonthlyDateLabel="Загрузка данных…",this.updateLastUpdatedPills(),this.elements.sumPlanned.textContent="…",this.elements.sumFact.textContent="…",this.elements.sumDelta.textContent="…",this.updateSummaryProgress(null,"…"),this.updateDailyAverage(null,0),this.setActiveCategoryTitle("Загрузка..."),this.elements.workEmptyState.style.display="none",this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows(),this.elements.pdfButton.disabled=!0,this.updateContractCard(null)}handleLoadError(){this.toggleSkeletons(!1),this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent="Ошибка загрузки данных",this.lastUpdatedMonthlyLabel="Ошибка загрузки данных",this.lastUpdatedMonthlyDateLabel="",this.updateLastUpdatedPills(),this.elements.sumPlanned.textContent="–",this.elements.sumFact.textContent="–",this.elements.sumDelta.textContent="–",this.elements.sumDelta.classList.remove("positive","negative"),this.summaryDailyRevenue=[],this.dailyRevenue=[],this.updateSummaryProgress(null,"–"),this.updateDailyAverage(null,0),this.updateContractCard(null),this.setActiveCategoryTitle("Смета не выбрана"),this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows(),this.elements.pdfButton.disabled=!0,this.elements.categoryGrid.innerHTML='<div class="empty-state">Ошибка загрузки данных</div>'}applyData(t){this.dataManager.setCurrentData(t),this.toggleSkeletons(!1);const e=Array.isArray(t.items)?t.items:[];this.groupedCategories=this.dataManager.buildCategories(e),this.ensureActiveCategory();const s=t.has_data?U(t.last_updated):"Нет данных",n=t.has_data?v(t.last_updated,{day:"2-digit",month:"2-digit",year:"numeric"}):"Нет данных";this.lastUpdatedMonthlyLabel=s,this.lastUpdatedMonthlyDateLabel=n,this.updateLastUpdatedPills();const o=t.has_data&&e.length>0;this.elements.pdfButton.disabled=!o,this.renderSummary(),this.renderCategories(),this.renderWorkList()}ensureActiveCategory(){this.activeCategoryKey&&this.groupedCategories.some(t=>t.key===this.activeCategoryKey)||(this.activeCategoryKey=this.groupedCategories.length?this.groupedCategories[0].key:null)}renderSummary(){const t=this.dataManager.getCurrentData(),e=t&&t.has_data?this.dataManager.calculateMetrics(t):null,s=this.dataManager.calculateContractMetrics(t||{});this.updateContractCard(s),this.metrics=e;const{summaryDailyRevenue:n,averageDailyRevenue:o,completion:i,completionLabel:r}=Nt({metrics:e,elements:this.elements});this.summaryDailyRevenue=n||[],this.dailyRevenue=[...this.summaryDailyRevenue],this.updateSummaryProgress(i,r),this.updateDailyAverage(o,this.summaryDailyRevenue.length)}updateSummaryProgress(t,e){Ut({completion:t,label:e,elements:this.elements})}updateLastUpdatedPills(){const t=this.lastUpdatedMonthlyLabel||"Нет данных",e=this.lastUpdatedMonthlyDateLabel||t,s=this.lastUpdatedDailyLabel||t,n=this.lastUpdatedDailyDateLabel||s;this.elements.lastUpdatedText&&(this.elements.lastUpdatedText.textContent=t),this.elements.lastUpdatedTextDaily&&(this.elements.lastUpdatedTextDaily.textContent=s),this.uiStore.getViewMode()==="daily"?this.updateContractTitleDate(n):this.updateContractTitleDate(e)}updateContractTitleDate(t){this.elements.contractTitleDate&&(this.elements.contractTitleDate.textContent=t?`на ${t}`:"")}updateContractCard(t){Ft({contractMetrics:t,elements:this.elements,formatMoneyFn:e=>p(e),formatPercentFn:e=>_(e)})}updateContractProgress(t){$t({completion:t,elements:this.elements})}updateDailyAverage(t,e){const s=this.isCurrentMonth(this.uiStore.getSelectedMonth());xt({averageValue:t,daysWithData:e,isCurrentMonth:s,elements:this.elements})}setDaySelectValue(t){!this.elements.daySelect||!t||(this.elements.daySelect.value=t)}showDailyLoadingState(){ae({elements:this.elements,setLastUpdated:({label:t,dateLabel:e})=>{this.lastUpdatedDailyLabel=t,this.lastUpdatedDailyDateLabel=e,this.updateLastUpdatedPills()}})}handleDailyLoadError(t="Ошибка загрузки данных"){se({elements:this.elements,message:t,setLastUpdated:({label:e,dateLabel:s})=>{this.lastUpdatedDailyLabel=e,this.lastUpdatedDailyDateLabel=s},updateLastUpdatedPills:()=>this.updateLastUpdatedPills()})}showDailyEmptyState(t){Q({elements:this.elements,message:t})}applyDailyData(t){this.currentDailyData=t;const{apply:e}=ne({data:t,elements:this.elements,formatDateTime:U,formatDate:v,updateLastUpdatedPills:({label:s,dateLabel:n})=>{this.lastUpdatedDailyLabel=s,this.lastUpdatedDailyDateLabel=n,this.updateLastUpdatedPills()},updateDailyNameCollapsers:()=>this.updateDailyNameCollapsers()});if(this.dailyModule&&typeof this.dailyModule.applyDailyData=="function"){e({applyFn:this.dailyModule.applyDailyData});return}this.loadDailyModule().then(s=>{const n=s&&(s.applyDailyData||s.default&&s.default.applyDailyData);typeof n=="function"?(this.dailyModule=s,e({applyFn:n})):(console.error("Модуль daily-report не экспортирует applyDailyData"),this.handleDailyLoadError())}).catch(s=>{console.error("Не удалось загрузить модуль daily-report:",s),this.handleDailyLoadError()})}async loadDailyData(t){if(!t){this.handleDailyLoadError("Выберите день, чтобы загрузить данные");return}this.selectedDayIso=t,this.setDaySelectValue(t);const e=this.dataManager.getCachedDaily(t);e?this.applyDailyData(e):this.showDailyLoadingState();try{const{data:s}=await this.dataManager.fetchDailyReport(t,{force:!!e});this.applyDailyData(s),this.announce(`Данные за ${de(t)} обновлены.`)}catch(s){console.error(s),e?this.announce("Не удалось обновить данные дня"):this.handleDailyLoadError()}}openDailyModal(){const t=this.uiStore.getSelectedMonth();!this.summaryDailyRevenue.length||!this.isCurrentMonth(t)||(this.selectedMonthIso=t,this.dailyRevenue=[...this.summaryDailyRevenue],this.dailyModalMode="average",this.renderDailyModalList(),oe({elements:this.elements,summaryDailyRevenue:this.summaryDailyRevenue,selectedMonthLabel:this.getSelectedMonthLabel(),isCurrentMonth:this.isCurrentMonth(t)}))}async openWorkModal(t){const e=this.uiStore.getSelectedMonth();if(!(!t||!this.elements.dailyModal||!this.isCurrentMonth(e))){this.selectedMonthIso=e;try{const s=await ie({elements:this.elements,item:t,selectedMonthIso:this.selectedMonthIso,dataManager:this.dataManager,visitorTracker:this.visitorTracker,setDailyModalState:({mode:n,dailyRevenue:o})=>{this.dailyModalMode=n,this.dailyRevenue=o}});this.dailyRevenue=s||[],this.renderDailyModalList()}catch(s){console.error("Ошибка загрузки расшифровки по работе:",s),x("Не удалось загрузить расшифровку по работе.","error")}}}closeDailyModal(){re({elements:this.elements})}renderDailyModalList(){le({elements:this.elements,dailyRevenue:this.dailyRevenue,dailyModalMode:this.dailyModalMode,selectedMonthLabel:this.getSelectedMonthLabel()})}renderCategories(){qt({groupedCategories:this.groupedCategories,activeCategoryKey:this.activeCategoryKey,elements:this.elements,onSelect:t=>{this.activeCategoryKey=t,this.renderCategories(),this.renderWorkList()}}),this.enhanceAccessibility()}renderWorkList(){const t=this.dataManager.getCurrentData(),e=this.groupedCategories.find(n=>n.key===this.activeCategoryKey)||null;if(this.elements.workSortSelect&&(this.elements.workSortSelect.disabled=!e),!e){this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent=t&&!t.has_data?"Данные за выбранный месяц отсутствуют":"Здесь появится список работ выбранной сметы.",this.setActiveCategoryTitle("Смета не выбрана"),this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows();return}const s=[...e.works];if(this.sortWorks(s),this.setActiveCategoryTitle(`Расшифровка работ по смете «${e.title}»`,e.title),!s.length){this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent="В этой смете нет строк для отображения",this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows();return}this.elements.workEmptyState.style.display="none",this.elements.workList.classList.add("has-data"),this.workHeaderEl.hidden=!1,this.elements.workListScroller.style.display="block",this.renderWorkRows(s)}handleWorkSortChange(t){!t||this.workSort.column===t||(this.workSort.column=t,this.updateWorkSortButtons(),this.renderWorkList())}updateWorkSortButtons(){this.workSortButtons&&this.workSortButtons.forEach(t=>{const e=t.dataset.sort===this.workSort.column;t.classList.toggle("active",e),t.setAttribute("aria-pressed",String(e))}),this.elements.workSortSelect&&this.elements.workSortSelect.value!==this.workSort.column&&(this.elements.workSortSelect.value=this.workSort.column)}getSortValueForWork(t){if(!t)return Number.NEGATIVE_INFINITY;let e;switch(this.workSort.column){case"fact":e=t.fact_amount;break;case"delta":e=S(t);break;case"planned":default:e=t.planned_amount??t.fact_amount;break}const s=Number(e);return Number.isFinite(s)?s:Number.NEGATIVE_INFINITY}sortWorks(t){return Array.isArray(t)?this.workSort.column==="delta"?(t.sort((e,s)=>{const n=S(e),o=S(s),i=n<0,r=o<0;if(i!==r)return i?-1:1;if(i&&r){const d=n-o;if(d!==0)return d}else{const d=o-n;if(d!==0)return d}const u=((e==null?void 0:e.work_name)||(e==null?void 0:e.description)||"").toLowerCase(),l=((s==null?void 0:s.work_name)||(s==null?void 0:s.description)||"").toLowerCase();return u.localeCompare(l)}),t):(t.sort((e,s)=>{const n=this.getSortValueForWork(e),i=this.getSortValueForWork(s)-n;if(i!==0)return i;const r=((e==null?void 0:e.work_name)||(e==null?void 0:e.description)||"").toLowerCase(),u=((s==null?void 0:s.work_name)||(s==null?void 0:s.description)||"").toLowerCase();return r.localeCompare(u)}),t):t}initializeNameToggle(t){if(!t)return;const e=t.querySelector(".work-row-name-toggle");e&&(t.dataset.expanded="false",e.addEventListener("click",()=>{const s=t.classList.toggle("work-row-name--expanded");s?t.classList.remove("work-row-name--collapsed"):t.classList.add("work-row-name--collapsed"),t.dataset.expanded=String(s),e.setAttribute("aria-expanded",String(s)),e.setAttribute("aria-label",s?"Свернуть название":"Развернуть полное название")}))}updateNameCollapsers(t){if(!t)return;t.querySelectorAll(".work-row-name").forEach(s=>{const n=s.querySelector(".work-row-name-text"),o=s.querySelector(".work-row-name-toggle");if(!n||!o)return;const i=s.dataset.expanded==="true";s.classList.toggle("work-row-name--expanded",i),i?s.classList.remove("work-row-name--collapsed"):s.classList.add("work-row-name--collapsed"),o.setAttribute("aria-expanded",String(i)),o.setAttribute("aria-label",i?"Свернуть название":"Развернуть полное название"),s.classList.remove("work-row-name--collapsible"),o.hidden=!0;const r=parseFloat(window.getComputedStyle(n).lineHeight||"0"),u=r&&!Number.isNaN(r)?r*2:null;(u?n.scrollHeight>u+1:n.scrollHeight>n.offsetHeight+1)?(s.classList.add("work-row-name--collapsible"),o.hidden=!1):i||s.classList.remove("work-row-name--collapsed")})}updateDailyNameCollapsers(){this.updateNameCollapsers(this.elements.dailyTable)}createWorkRow(t,e,s){const n=t.work_name||t.description||"Без названия",o=S(t),i=o>0?"delta-positive":o<0?"delta-negative":"",r=p(t.planned_amount),u=p(t.fact_amount),l=p(o),d=document.createElement("div");return d.className="work-row",e===s-1&&d.classList.add("work-row-last"),d.innerHTML=`
      <div class="work-row-name work-row-name--collapsed" data-expanded="false">
        <span class="work-row-name-text">${n}</span>
        <button
          type="button"
          class="work-row-name-toggle"
          aria-expanded="false"
          aria-label="Развернуть полное название"
        >
          <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
        </button>
      </div>
      <div class="work-row-money work-row-plan">
        <span class="work-row-label">План</span>
        <span>${r}</span>
      </div>
      <div class="work-row-money work-row-fact">
        <span class="work-row-label">Факт</span>
        <span>${u}</span>
      </div>
      <div class="work-row-delta ${i}">
        <span class="work-row-label">Отклонение</span>
        <span class="work-row-delta-value">${l}</span>
      </div>
    `,this.initializeNameToggle(d.querySelector(".work-row-name")),d.addEventListener("click",c=>{if(!c.target.closest(".work-row-name-toggle"))try{this.openWorkModal(t)}catch(h){console.error(h)}}),d}updateWorkNameCollapsers(){this.updateNameCollapsers(this.elements.workListScroller)}getSelectedMonthLabel(){const t=this.elements.monthSelect.options[this.elements.monthSelect.selectedIndex];return t?t.textContent.trim():""}async downloadPdfReport(t){if(t.preventDefault(),this.elements.pdfButton.disabled)return;const s=(this.getSelectedMonthLabel()||this.elements.monthSelect.value||"period").toString().trim().replace(/\s+/g,"-").replace(/[^0-9A-Za-zА-Яа-я\-]+/g,"").replace(/-+/g,"-").replace(/^-|-$/g,""),n=s?`mad-podolsk-otchet-${s}.pdf`:"mad-podolsk-otchet.pdf";this.elements.pdfButton.disabled=!0,this.elements.pdfButton.innerHTML="Формируем PDF…";try{const o=new URL(this.apiPdfUrl,window.location.origin);o.searchParams.set("month",this.elements.monthSelect.value);const i=await fetch(o.toString(),{headers:{Accept:"application/pdf",...this.visitorTracker?this.visitorTracker.buildHeaders():{}}});if(!i.ok)throw new Error("HTTP "+i.status);const r=await i.blob(),u=URL.createObjectURL(r),l=document.createElement("a");l.href=u,l.download=n,l.style.display="none",document.body.appendChild(l),l.click(),l.remove(),setTimeout(()=>URL.revokeObjectURL(u),0),this.announce("PDF-отчёт сформирован.")}catch(o){console.error("PDF export error",o),x("Не удалось сформировать PDF. Попробуйте ещё раз позже.","error"),this.announce("Ошибка формирования PDF")}finally{this.elements.pdfButton.innerHTML=this.pdfButtonDefaultLabel,this.elements.pdfButton.disabled=!this.groupedCategories.length}}enhanceAccessibility(){this.elements.categoryGrid.querySelectorAll(".category-card").forEach((e,s)=>{var o,i;const n=((i=(o=e.querySelector(".category-title span"))==null?void 0:o.textContent)==null?void 0:i.trim())||`Смета ${s+1}`;e.setAttribute("role","button"),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",`Смета ${n}`),e.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),e.click())})})}createLiveRegion(){const t=document.createElement("div");return t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",document.body.appendChild(t),t}announce(t){this.liveRegion&&(this.liveRegion.textContent="",requestAnimationFrame(()=>{this.liveRegion.textContent=t}))}}function ue(){const a=et(gt),t=a.pdfButton?a.pdfButton.innerHTML:ft;st({pdfButton:a.pdfButton,workSortSelect:a.workSortSelect},!0);const e=window.matchMedia(pt),s=n=>{if(!a.pdfButton||!a.pdfButtonContainerDesktop||!a.pdfButtonContainerMobile)return;const o=n?a.pdfButtonContainerMobile:a.pdfButtonContainerDesktop;a.pdfButton.parentElement!==o&&o.appendChild(a.pdfButton)};return s(e.matches),e.addEventListener("change",n=>s(n.matches)),{elements:a,pdfButtonDefaultLabel:t}}function he(){const a=new kt,t=new Dt(P,{monthsUrl:G,daysUrl:K,dailyUrl:q,visitorTracker:a});return{visitorTracker:a,dataManager:t}}function ye({elements:a,pdfButtonDefaultLabel:t,dataManager:e,visitorTracker:s}){const n=new ce({dataManager:e,elements:a,apiPdfUrl:mt,pdfButtonDefaultLabel:t,visitorTracker:s});return n.init(),{uiManager:n}}function me(){const{elements:a,pdfButtonDefaultLabel:t}=ue(),{visitorTracker:e,dataManager:s}=he();ye({elements:a,pdfButtonDefaultLabel:t,dataManager:s,visitorTracker:e});const n=new URL(P,window.location.origin).pathname;e.logInitialVisit({apiBase:M,endpoint:n})}function pe(){me()}document.addEventListener("DOMContentLoaded",()=>{pe()});export{ge as a,fe as b,v as f};
