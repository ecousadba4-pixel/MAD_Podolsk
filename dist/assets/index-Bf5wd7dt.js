(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();function Y(s){return Object.fromEntries(Object.entries(s).map(([t,e])=>[t,document.querySelector(e)]))}function y(s){return s==null||isNaN(s)?"–":s.toLocaleString("ru-RU",{maximumFractionDigits:0})}function E(s){const t=y(s);return t==="–"?t:`${t} ₽`}function C(s){return s==null||isNaN(s)?"–":(s*100).toFixed(1)+" %"}function P(s){return s?new Date(s).toLocaleString("ru-RU"):"—"}function p(s,t={day:"2-digit",month:"long"}){if(!s)return"—";const e=new Date(s);return Number.isNaN(e.getTime())?"—":e.toLocaleDateString("ru-RU",t)}function X(s,t={maximumFractionDigits:3}){if(s==null||Number.isNaN(s))return"–";const e={minimumFractionDigits:0,...t};return Number(s).toLocaleString("ru-RU",e)}function T(s,t="success"){const e=document.createElement("div");e.className=`toast ${t}`,e.textContent=s,document.body.appendChild(e),setTimeout(()=>{e.style.animation="slideIn 0.3s ease reverse",setTimeout(()=>e.remove(),300)},3e3)}function w(s){if(s.delta_amount!==null&&s.delta_amount!==void 0)return s.delta_amount;const t=s.planned_amount??0;return(s.fact_amount??0)-t}function z(s,t){let e;return(...a)=>{clearTimeout(e),e=setTimeout(()=>s(...a),t)}}function v(s){if(s==null)return null;const t=typeof s=="number"?s:Number(s);return Number.isFinite(t)?t:null}function j(s,t=!0){Object.values(s).forEach(e=>{e&&typeof e.disabled=="boolean"&&(e.disabled=t)})}const Q="/api/dashboard",J="/months",Z="/days",tt="/daily",$=(()=>{const s=document.querySelector('meta[name="mad-api-url"]');return((s==null?void 0:s.content)||window.MAD_API_URL||"").trim()||Q})(),_=$.replace(/\/$/,""),et=`${_}${J}`,at=`${_}${Z}`,st=`${_}${tt}`,nt={внерегл_ч_1:{key:"внерегламент",title:"внерегламент"},внерегл_ч_2:{key:"внерегламент",title:"внерегламент"}},it=new Set([408,425,429,500,502,503,504]),k=700;function R(s){const t=v(s);return t!==null&&t!==0}function ot(s){return s?R(s.planned_amount)||R(s.fact_amount):!1}function lt(s,t){const e=(s||"").trim(),a=nt[e.toLowerCase()];if(a)return{...a};const n=(t||"").trim(),i=e||n||"Прочее";return{key:i,title:n||i}}async function rt(s=k){return new Promise(t=>setTimeout(t,s))}function b(s){const t=new Error("HTTP "+s.status);return t.retryable=it.has(s.status),t}function dt(s){if(!s)return!1;if(s.retryable===!0)return!0;if(s.retryable===!1)return!1;const t=(s.message||"").toLowerCase();return s.name==="TypeError"||t.includes("network")||t.includes("timeout")||t.includes("timed out")||t.includes("connection")}async function D(s,{retries:t=1,delayMs:e=k}={}){let a;for(let n=0;n<=t;n+=1)try{return await s()}catch(i){if(a=i,n===t||!dt(i))break;await rt(e)}throw a}class ct{constructor(t=$,{monthsUrl:e=et,daysUrl:a=at,dailyUrl:n=st,visitorTracker:i}={}){this.apiUrl=t,this.monthsUrl=e,this.daysUrl=a,this.dailyUrl=n,this.cache=new Map,this.dailyCache=new Map,this.currentData=null,this.visitorTracker=i||null}getCached(t){return this.cache.get(t)||null}async fetchData(t,{force:e=!1}={}){if(!t)throw new Error("Не указан месяц для загрузки данных дашборда");if(!e&&this.cache.has(t))return{data:this.cache.get(t),fromCache:!0};const a=new URL(this.apiUrl,window.location.origin);a.searchParams.set("month",t),a.searchParams.set("_",Date.now().toString());const n={"Cache-Control":"no-cache",Pragma:"no-cache",...this.visitorTracker?this.visitorTracker.buildHeaders():{}},o=await(await D(()=>fetch(a.toString(),{cache:"no-store",headers:n}).then(l=>{if(!l.ok)throw b(l);return l}),{delayMs:k})).json();return this.cache.set(t,o),{data:o,fromCache:!1}}async fetchAvailableMonths(){const e=await(await D(()=>fetch(this.monthsUrl,{cache:"no-store",headers:this.visitorTracker?this.visitorTracker.buildHeaders():void 0}).then(a=>{if(!a.ok)throw b(a);return a}),{delayMs:k})).json();return Array.isArray(e==null?void 0:e.months)?e.months:[]}async fetchAvailableDays(){const e=await(await D(()=>fetch(this.daysUrl,{cache:"no-store",headers:this.visitorTracker?this.visitorTracker.buildHeaders():void 0}).then(a=>{if(!a.ok)throw b(a);return a}),{delayMs:k})).json();return Array.isArray(e==null?void 0:e.days)?e.days:[]}getCachedDaily(t){return this.dailyCache.get(t)||null}async fetchDailyReport(t,{force:e=!1}={}){if(!t)throw new Error("Не указана дата для загрузки дневного отчёта");if(!e&&this.dailyCache.has(t))return{data:this.dailyCache.get(t),fromCache:!0};const a=new URL(this.dailyUrl,window.location.origin);a.searchParams.set("day",t),a.searchParams.set("_",Date.now().toString());const n={"Cache-Control":"no-cache",Pragma:"no-cache",...this.visitorTracker?this.visitorTracker.buildHeaders():{}},o=await(await D(()=>fetch(a.toString(),{cache:"no-store",headers:n}).then(l=>{if(!l.ok)throw b(l);return l}),{delayMs:k})).json();return this.dailyCache.set(t,o),{data:o,fromCache:!1}}setCurrentData(t){this.currentData=t}getCurrentData(){return this.currentData}summarizeItems(t=[]){return t.reduce((e,a)=>(a.planned_amount!==null&&a.planned_amount!==void 0&&(e.planned+=a.planned_amount,e.hasPlanned=!0),a.fact_amount!==null&&a.fact_amount!==void 0&&(e.fact+=a.fact_amount,e.hasFact=!0),e),{planned:0,fact:0,hasPlanned:!1,hasFact:!1})}calculateMetrics(t){if(!t)return null;const e=t.items||[],a=this.summarizeItems(e),n=t.summary||{},i=n.planned_amount??(a.hasPlanned?a.planned:null),o=n.fact_amount??(a.hasFact?a.fact:null),l=n.completion_pct??(i?(o??0)/i:null),c=n.delta_amount!==null&&n.delta_amount!==void 0?n.delta_amount:i!==null||o!==null?(o??0)-(i??0):null,d=Array.isArray(n.daily_revenue)?n.daily_revenue.map(u=>{const m=v((u==null?void 0:u.amount)??(u==null?void 0:u.fact_total)??(u==null?void 0:u.value)),f=(u==null?void 0:u.date)||(u==null?void 0:u.work_date)||(u==null?void 0:u.day);return!f||m===null?null:{date:f,amount:m}}).filter(Boolean):[],h=v(n.average_daily_revenue)??(d.length?d.reduce((u,m)=>u+m.amount,0)/d.length:null);return{planned:i,fact:o,completion:l,delta:c,dailyRevenue:d,averageDailyRevenue:h}}calculateContractMetrics(t){if(!t||!t.summary)return null;const e=t.summary,a=v(e.contract_amount),n=v(e.contract_executed),i=e.contract_completion_pct??(a?(n??0)/a:null);return{contractAmount:a,executed:n,completion:i}}buildCategories(t=[]){const e=new Map;return t.forEach(a=>{if(!ot(a))return;const n=a.category||a.smeta||"",i=n?n.trim():"";if(!i||i.toLowerCase()==="без категории")return;const{key:o,title:l}=lt(i,a.smeta);e.has(o)||e.set(o,{key:o,title:l,works:[],planned:0,fact:0,delta:0});const r=e.get(o);!r.title&&l&&(r.title=l),a.category_plan_only===!0||r.works.push(a);const d=a.planned_amount??0,h=a.fact_amount??0,u=w(a);isNaN(d)||(r.planned+=d),isNaN(h)||(r.fact+=h),isNaN(u)||(r.delta+=u)}),Array.from(e.values()).sort((a,n)=>{const i=isNaN(a.planned)?0:a.planned,o=isNaN(n.planned)?0:n.planned;if(i===o){const l=(a.title||"").toLowerCase(),r=(n.title||"").toLowerCase();return l.localeCompare(r,"ru")}return o-i})}}function ut({container:s,onSortChange:t,onWorkClick:e}){const a=document.createElement("div");a.className="work-row work-row-header",a.innerHTML=`
      <div>Работа</div>
      <div>
        <button type="button" class="work-sort-button" data-sort="planned">
          <span>План, ₽</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по плану (по убыванию)</span>
        </button>
      </div>
      <div>
        <button type="button" class="work-sort-button" data-sort="fact">
          <span>Факт, ₽</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по факту (по убыванию)</span>
        </button>
      </div>
      <div>
        <button type="button" class="work-sort-button" data-sort="delta">
          <span>Отклонение</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по отклонению (по убыванию)</span>
        </button>
      </div>
    `,a.hidden=!0,s.appendChild(a);const n=document.createElement("div");n.className="work-list-scroller",n.style.display="none",s.appendChild(n);const i=Array.from(a.querySelectorAll(".work-sort-button"));return i.forEach(o=>{o.addEventListener("click",()=>{const l=o.dataset.sort;t&&t(l)})}),{headerEl:a,scroller:n,sortButtons:i}}function ht({scroller:s,works:t,onWorkClick:e,initializeNameToggle:a,calculateDeltaFn:n=w}){if(!s||(s.innerHTML="",!Array.isArray(t)||!t.length))return;const i=document.createDocumentFragment();t.forEach((o,l)=>{const r=mt(o,l,t.length,n,e,a);r&&i.appendChild(r)}),s.appendChild(i)}function mt(s,t,e,a,n,i){const o=s.work_name||s.description||"Без названия",l=a(s),r=l>0?"delta-positive":l<0?"delta-negative":"",c=y(s.planned_amount),d=y(s.fact_amount),h=y(l),u=document.createElement("div");return u.className="work-row",t===e-1&&u.classList.add("work-row-last"),u.innerHTML=`
      <div class="work-row-name work-row-name--collapsed" data-expanded="false">
        <span class="work-row-name-text">${o}</span>
        <button
          type="button"
          class="work-row-name-toggle"
          aria-expanded="false"
          aria-label="Развернуть полное название"
        >
          <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
        </button>
      </div>
      <div class="work-row-money work-row-plan">
        <span class="work-row-label">План</span>
        <span>${c}</span>
      </div>
      <div class="work-row-money work-row-fact">
        <span class="work-row-label">Факт</span>
        <span>${d}</span>
      </div>
      <div class="work-row-delta ${r}">
        <span class="work-row-label">Отклонение</span>
        <span class="work-row-delta-value">${h}</span>
      </div>
    `,i&&i(u.querySelector(".work-row-name")),u.addEventListener("click",m=>{m.target.closest(".work-row-name-toggle")||n&&n(s,m)}),u}function yt({data:s,elements:t,onAfterRender:e}){t.dailySkeleton&&(t.dailySkeleton.style.display="none");const a=Array.isArray(s==null?void 0:s.items)?s.items:[];if(a.length?t.dailyEmptyState&&(t.dailyEmptyState.style.display="none"):(t.dailyEmptyState&&(t.dailyEmptyState.style.display="block",t.dailyEmptyState.textContent="Нет данных по выбранному дню"),t.dailyTable&&(t.dailyTable.style.display="none")),t.dailyPanelTitle){const n=p(s==null?void 0:s.date,{day:"2-digit",month:"long"});t.dailyPanelTitle.textContent=n?`Данные за ${n}`:"Данные за выбранный день"}if(t.dailyPanelSubtitle){const i=p(s==null?void 0:s.date,{day:"2-digit",month:"long"})?"Данные доступны только для текущего месяца":"Выберите день, чтобы увидеть данные";t.dailyPanelSubtitle.textContent=i,t.dailyPanelSubtitle.hidden=!1}pt(a,t),e&&e()}function pt(s,t){if(!t.dailyTable)return;const{dailyTable:e,dailyEmptyState:a}=t;if(e.innerHTML="",!Array.isArray(s)||!s.length){a&&(a.textContent="Нет данных по выбранному дню",a.style.display="block"),e.style.display="none";return}const n=[...s].sort((c,d)=>{const h=Number.isFinite(Number(c==null?void 0:c.total_amount))?Number(c.total_amount):0;return(Number.isFinite(Number(d==null?void 0:d.total_amount))?Number(d.total_amount):0)-h});e.style.display="block",e.classList.add("has-data");const i=document.createElement("div");i.className="work-row work-row-header",i.innerHTML=`
      <div>Смета</div>
      <div>Работы</div>
      <div>Ед. изм.</div>
      <div>Объём</div>
      <div>Сумма, ₽</div>
    `;const o=document.createDocumentFragment();o.appendChild(i),n.forEach((c,d)=>{const h=document.createElement("div");h.className="work-row daily-row",d===n.length-1&&h.classList.add("work-row-last"),h.innerHTML=`
        <div class="daily-cell daily-cell-smeta">${c.smeta||"—"}</div>
        <div class="daily-cell daily-cell-name">
          <div class="work-row-name work-row-name--collapsed" data-expanded="false">
            <span class="work-row-name-text">${c.description||"Без названия"}</span>
            <button
              type="button"
              class="work-row-name-toggle"
              aria-expanded="false"
              aria-label="Развернуть полное название"
            >
              <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="daily-cell daily-cell-unit">
          <span class="daily-cell-label">Ед. изм.</span>
          <span class="daily-cell-value">${c.unit||"—"}</span>
        </div>
        <div class="daily-cell daily-cell-volume">
          <span class="daily-cell-label">Объём</span>
          <span class="daily-cell-value"><strong>${X(c.total_volume,{maximumFractionDigits:3})}</strong></span>
        </div>
        <div class="daily-cell daily-cell-amount">
          <span class="daily-cell-label">Сумма</span>
          <span class="daily-cell-value"><strong>${E(c.total_amount)}</strong></span>
        </div>
      `,o.appendChild(h)});const l=n.reduce((c,d)=>{const h=Number(d.total_amount);return c+(Number.isFinite(h)?h:0)},0),r=document.createElement("div");r.className="work-row work-row-total daily-total-row",r.innerHTML=`
      <div class="daily-cell daily-cell-total-label">Итого по сумме</div>
      <div class="daily-cell daily-cell-total-gap"></div>
      <div class="daily-cell daily-cell-total-gap"></div>
      <div class="daily-cell daily-cell-total-gap"></div>
      <div class="daily-cell daily-cell-total-amount"><strong>${E(l)}</strong></div>
    `,o.appendChild(r),e.appendChild(o)}const F=115,I=120,H="#16a34a",ft="var(--accent)",gt=78,wt=43,vt=47;function kt({metrics:s,elements:t}){if(!s)return t.sumPlanned&&(t.sumPlanned.textContent="–"),t.sumFact&&(t.sumFact.textContent="–"),t.sumDelta&&(t.sumDelta.textContent="–",t.sumDelta.classList.remove("positive","negative")),{dailyRevenue:[],averageDailyRevenue:null};const e=Array.isArray(s.dailyRevenue)?s.dailyRevenue:[];t.sumPlanned&&(t.sumPlanned.textContent=y(s.planned)),t.sumFact&&(t.sumFact.textContent=y(s.fact)),t.sumDelta&&(t.sumDelta.textContent=y(s.delta),t.sumDelta.classList.remove("positive","negative"),s.delta>0&&t.sumDelta.classList.add("positive"),s.delta<0&&t.sumDelta.classList.add("negative"));const a=s.completion!==null&&s.completion!==void 0?C(s.completion):"–";return{summaryDailyRevenue:e,averageDailyRevenue:s.averageDailyRevenue,completion:s.completion,completionLabel:a}}function St({completion:s,label:t,elements:e}){const a=s!=null&&!Number.isNaN(s)?Math.max(0,s*100):0,n=Math.min(F,a),i=Math.min(I,Math.max(0,a)),o=a>100?H:`hsl(${i}, ${gt}%, ${a>=50?wt:vt}%)`;e.sumFactProgress&&(e.sumFactProgress.style.width=`${n}%`,e.sumFactProgress.classList.toggle("overflow",a>100),e.sumFactProgress.style.setProperty("--progress-color",o)),e.sumFactProgressLabel&&(e.sumFactProgressLabel.textContent=t)}function bt({averageValue:s,daysWithData:t,isCurrentMonth:e,elements:a}){const i=Number.isFinite(t)&&t>0&&e;if(a.sumDailyAverage&&(a.sumDailyAverage.textContent=s!=null&&!Number.isNaN(s)?y(s):"–"),a.dailyAverageCard){a.dailyAverageCard.classList.toggle("is-disabled",!i),a.dailyAverageCard.setAttribute("aria-disabled",String(!i));const o=a.dailyAverageCard.querySelector(".sr-only");o&&(o.hidden=!i)}}function Dt({contractMetrics:s,elements:t,formatMoneyFn:e=y,formatPercentFn:a=C}){if(!t.contractCard)return;const n=s&&s.contractAmount!==null&&s.executed!==null,i=n?s.completion:null,o=i!=null&&!Number.isNaN(i)?a(i):"–";t.contractAmount&&(t.contractAmount.textContent=n?e(s.contractAmount):"–"),t.contractExecuted&&(t.contractExecuted.textContent=n?e(s.executed):"–"),t.contractPercent&&(t.contractPercent.textContent=o),Lt({completion:i,elements:t})}function Lt({completion:s,elements:t}){if(!t.contractProgress)return;const e=s!=null&&!Number.isNaN(s)?Math.max(0,s*100):0,a=Math.min(F,e),n=e>100,i=n?H:ft;t.contractProgress.style.width=`${a}%`,t.contractProgress.style.setProperty("--progress-color",i),t.contractProgress.style.background=i,t.contractProgress.classList.toggle("overflow",n),t.contractProgress.parentElement&&t.contractProgress.parentElement.setAttribute("aria-valuenow",Math.min(I,e).toFixed(1))}const Mt=115,N=120,Ct="#16a34a",At=78,_t=43,Et=47;function Pt({groupedCategories:s,activeCategoryKey:t,elements:e,colors:a,onSelect:n}){if(e.categoryGrid.innerHTML="",!s.length){const o="Нет данных для отображения";e.categoryGrid.innerHTML=`<div class="empty-state">${o}</div>`,n&&n(null);return}const i=document.createDocumentFragment();s.forEach((o,l)=>{const r=a[l%a.length],c=document.createElement("button");c.type="button",c.className=`card card--interactive category-card${o.key===t?" active":""}`,c.style.setProperty("--accent",r.accent),c.style.setProperty("--accent-soft",r.soft);const d=typeof o.key=="string"&&o.key.toLowerCase()==="внерегламент",h=o.delta>0?"delta-positive":o.delta<0?"delta-negative":"",u=o.planned?(o.fact??0)/o.planned:null,m=u!==null&&!Number.isNaN(u)&&Number.isFinite(u),f=m?C(u):"–",g=m?Math.max(0,u*100):0,B=Math.min(Mt,g),O=g>100?" overflow":"",W=Math.min(N,Math.max(0,g)),G=g>100?Ct:`hsl(${W}, ${At}%, ${g>=50?_t:Et}%)`,K=`width: ${B}%; --progress-color: ${G};`,V=m?Math.min(N,g).toFixed(1):"0",q=d?'<span class="category-offplan-note"><span>30% от</span><span>общего плана</span></span>':`<span class="category-pill">${o.works.length} работ</span>`;c.innerHTML=`
        <div class="category-title">
          <span>${o.title}</span>
          ${q}
        </div>
        <div class="category-values">
          <span><span class="label">План</span><strong>${y(o.planned)}</strong></span>
          <span><span class="label">Факт</span><strong>${y(o.fact)}</strong></span>
          <span><span class="label">Отклонение</span><strong class="category-delta ${h}">${y(o.delta)}</strong></span>
        </div>
        <div class="category-progress">
          <div class="category-progress-labels">
            <span>Исполнение плана</span>
            <strong>${f}</strong>
          </div>
          <div class="category-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="120" aria-valuenow="${V}">
            <div class="category-progress-fill${O}" style="${K}"></div>
          </div>
        </div>
      `,c.setAttribute("aria-pressed",o.key===t?"true":"false"),c.addEventListener("click",()=>{n&&n(o.key)}),i.appendChild(c)}),e.categoryGrid.appendChild(i)}const Tt=[{accent:"#22c55e",soft:"rgba(34, 197, 94, 0.25)"},{accent:"#2563eb",soft:"rgba(37, 99, 235, 0.25)"},{accent:"#f97316",soft:"rgba(249, 115, 22, 0.25)"},{accent:"#dc2626",soft:"rgba(220, 38, 38, 0.25)"},{accent:"#a855f7",soft:"rgba(168, 85, 247, 0.25)"},{accent:"#0f766e",soft:"rgba(15, 118, 110, 0.25)"}];class Rt{constructor({dataManager:t,elements:e,apiPdfUrl:a,pdfButtonDefaultLabel:n,visitorTracker:i}){this.dataManager=t,this.elements=e,this.apiPdfUrl=a,this.pdfButtonDefaultLabel=n,this.visitorTracker=i||null,this.groupedCategories=[],this.activeCategoryKey=null,this.workHeaderEl=null,this.liveRegion=null,this.metrics=null,this.lastUpdatedMonthlyLabel=null,this.lastUpdatedMonthlyDateLabel=null,this.lastUpdatedDailyLabel=null,this.lastUpdatedDailyDateLabel=null,this.summaryDailyRevenue=[],this.dailyRevenue=[],this.workSort={column:"planned"},this.selectedMonthIso=null,this.selectedDayIso=null,this.availableDays=[],this.initialMonth=new URLSearchParams(window.location.search).get("month"),this.viewMode="monthly",this.dayOptionsLoaded=!1,this.currentDailyData=null,this.elements.workSortSelect&&(this.elements.workSortSelect.value=this.workSort.column),this.handleResize=z(()=>{this.updateWorkNameCollapsers(),this.updateDailyNameCollapsers()},150),this.monthOptionsLoaded=!1}setActiveCategoryTitle(t,e=t){this.elements.activeCategoryTitleDesktop?this.elements.activeCategoryTitleDesktop.textContent=t:this.elements.activeCategoryTitle&&(this.elements.activeCategoryTitle.textContent=t),this.elements.activeCategoryTitleMobileValue&&(this.elements.activeCategoryTitleMobileValue.textContent=e)}init(){this.prepareWorkList(),this.liveRegion=this.createLiveRegion(),this.bindEvents(),this.elements.workDetailHint&&(this.elements.workDetailHint.hidden=!0),this.updateViewModeLayout(),this.initMonthSelect(),window.addEventListener("resize",this.handleResize)}toggleSkeletons(t){this.elements.summarySkeleton&&(this.elements.summarySkeleton.style.display=t?"grid":"none"),this.elements.categorySkeleton&&(this.elements.categorySkeleton.style.display=t?"grid":"none"),this.elements.workSkeleton&&(this.elements.workSkeleton.style.display=t?"block":"none"),this.elements.summaryGrid&&(this.elements.summaryGrid.hidden=t),this.elements.categoryGrid&&(this.elements.categoryGrid.style.display=t?"none":""),this.elements.workList&&(this.elements.workList.style.display=t?"none":"")}updateViewModeLayout(){this.elements.page&&(this.elements.page.dataset.viewMode=this.viewMode),this.elements.viewModeMonthly&&(this.elements.viewModeMonthly.classList.toggle("is-active",this.viewMode==="monthly"),this.elements.viewModeMonthly.setAttribute("aria-selected",this.viewMode==="monthly"?"true":"false")),this.elements.viewModeDaily&&(this.elements.viewModeDaily.classList.toggle("is-active",this.viewMode==="daily"),this.elements.viewModeDaily.setAttribute("aria-selected",this.viewMode==="daily"?"true":"false"));const t=this.viewMode==="daily";this.elements.pdfButton&&(this.elements.pdfButton.disabled=t||!this.groupedCategories.length),this.updateLastUpdatedPills()}prepareWorkList(){const{headerEl:t,scroller:e,sortButtons:a}=ut({container:this.elements.workList,onSortChange:n=>this.handleWorkSortChange(n),onWorkClick:(n,i)=>{i&&i.target.closest(".work-row-name-toggle")||this.openWorkModal(n)}});this.workHeaderEl=t,this.elements.workListScroller=e,this.workSortButtons=a,this.updateWorkSortButtons()}clearWorkRows(){this.elements.workListScroller&&(this.elements.workListScroller.innerHTML="")}renderWorkRows(t){ht({scroller:this.elements.workListScroller,works:t,onWorkClick:(e,a)=>{a&&a.target.closest(".work-row-name-toggle")||this.openWorkModal(e)},initializeNameToggle:e=>this.initializeNameToggle(e),calculateDeltaFn:e=>w(e)}),requestAnimationFrame(()=>this.updateWorkNameCollapsers())}bindEvents(){this.elements.workSortSelect&&this.elements.workSortSelect.addEventListener("change",t=>{const e=t.target.value;this.handleWorkSortChange(e)}),this.elements.pdfButton.addEventListener("click",t=>this.downloadPdfReport(t)),this.elements.dailyAverageCard&&this.elements.dailyAverageCard.addEventListener("click",()=>this.openDailyModal()),this.elements.dailyModalClose&&this.elements.dailyModalClose.addEventListener("click",()=>this.closeDailyModal()),this.elements.dailyModal&&this.elements.dailyModal.addEventListener("click",t=>{t.target===this.elements.dailyModal&&this.closeDailyModal()}),this.elements.viewModeMonthly&&this.elements.viewModeMonthly.addEventListener("click",()=>this.switchViewMode("monthly")),this.elements.viewModeDaily&&this.elements.viewModeDaily.addEventListener("click",()=>this.switchViewMode("daily")),this.elements.daySelect&&this.elements.daySelect.addEventListener("change",()=>{this.loadDailyData(this.elements.daySelect.value)})}async initMonthSelect(){if(!this.elements.monthSelect)return;const t=this.elements.monthSelect;t.innerHTML="",t.disabled=!0;try{const a=(await this.dataManager.fetchAvailableMonths()||[]).map(i=>{if(!i)return null;const o=new Date(i);return Number.isNaN(o.getTime())?null:{iso:i,label:o.toLocaleDateString("ru-RU",{month:"long",year:"numeric"})}}).filter(Boolean);if(!a.length){const i=this.initialMonth||this.getCurrentMonthIso();this.setMonthSelectPlaceholder("Нет данных"),i?await this.loadMonthData(i):this.handleLoadError();return}const n=this.initialMonth&&a.some(i=>i.iso===this.initialMonth);a.forEach((i,o)=>{const l=document.createElement("option");l.value=i.iso,l.textContent=i.label,(n&&i.iso===this.initialMonth||!n&&o===0)&&(l.selected=!0),t.appendChild(l)}),this.monthOptionsLoaded||(t.addEventListener("change",()=>{this.loadMonthData(t.value)}),this.monthOptionsLoaded=!0),t.disabled=!1,this.loadMonthData(t.value||a[0].iso)}catch(e){console.error("Не удалось загрузить список месяцев",e),this.setMonthSelectPlaceholder("Ошибка загрузки"),this.handleLoadError()}}async initDaySelect(){var e;if(!this.elements.daySelect)return;const t=this.elements.daySelect;t.value="",t.disabled=!0,t.min="",t.max="",this.selectedDayIso=null;try{const a=await this.dataManager.fetchAvailableDays();if(this.availableDays=(a||[]).map(l=>{const r=new Date(l);return Number.isNaN(r.getTime())?null:{iso:r.toISOString().slice(0,10),label:p(r,{day:"2-digit",month:"long"})}}).filter(Boolean).sort((l,r)=>l.iso<r.iso?1:-1),!this.availableDays.length){const l=this.getCurrentDayIso();this.availableDays=l?[{iso:l,label:p(l,{day:"2-digit",month:"long"})}]:[]}const n=this.availableDays.reduce((l,r)=>!l||r.iso<l?r.iso:l,null),i=this.availableDays.reduce((l,r)=>!l||r.iso>l?r.iso:l,null);n&&(t.min=n),i&&(t.max=i);const o=this.selectedDayIso&&this.availableDays.some(l=>l.iso===this.selectedDayIso)?this.selectedDayIso:(e=this.availableDays[0])==null?void 0:e.iso;o&&(t.value=o,this.selectedDayIso=o),this.dayOptionsLoaded=!0,t.disabled=!1}catch(a){console.error("Не удалось загрузить список дней",a),t.value="",t.placeholder="Ошибка загрузки",t.setAttribute("aria-invalid","true"),this.dayOptionsLoaded=!1}}getCurrentMonthIso(){const t=new Date,e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0");return`${e}-${a}-01`}getCurrentDayIso(){const t=new Date,e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${n}`}getMonthKey(t){if(!t)return null;const e=/^(\d{4})-(\d{1,2})/.exec(t);if(e){const a=Number(e[1]),n=Number(e[2]);if(!Number.isNaN(a)&&n>=1&&n<=12)return`${a}-${n-1}`}return null}isCurrentMonth(t){const e=this.getMonthKey(t);if(!e)return!1;const a=new Date,n=`${a.getFullYear()}-${a.getMonth()}`;return e===n}async switchViewMode(t){var a;const e=t==="daily"?"daily":"monthly";if(this.viewMode!==e)if(this.viewMode=e,this.updateViewModeLayout(),e==="daily"){this.dayOptionsLoaded||await this.initDaySelect();const n=((a=this.elements.daySelect)==null?void 0:a.value)||this.selectedDayIso||(this.availableDays[0]?this.availableDays[0].iso:null)||this.getCurrentDayIso();n?(this.setDaySelectValue(n),await this.loadDailyData(n)):this.showDailyEmptyState("Нет данных за текущий месяц")}else this.updateLastUpdatedPills()}updateDailyAverageVisibility(t=this.selectedMonthIso){const e=this.isCurrentMonth(t);this.elements.dailyAverageNote&&(this.elements.dailyAverageNote.hidden=!e),this.elements.dailyAverageHint&&(this.elements.dailyAverageHint.hidden=!e),this.elements.workDetailHint&&(this.elements.workDetailHint.hidden=!e)}setMonthSelectPlaceholder(t){if(!this.elements.monthSelect)return;const e=document.createElement("option");e.value="",e.textContent=t,e.disabled=!0,e.selected=!0,this.elements.monthSelect.appendChild(e),this.elements.monthSelect.disabled=!0}async loadMonthData(t){this.selectedMonthIso=t,this.updateDailyAverageVisibility(t);const e=this.dataManager.getCached(t);e?this.applyData(e):this.showLoadingState();try{const{data:a}=await this.dataManager.fetchData(t,{force:!!e});this.applyData(a),this.announce(`Данные за ${this.getSelectedMonthLabel()||"выбранный месяц"} обновлены.`)}catch(a){console.error(a),e?this.announce("Не удалось обновить данные"):this.handleLoadError()}}showLoadingState(){this.groupedCategories=[],this.activeCategoryKey=null,this.summaryDailyRevenue=[],this.dailyRevenue=[],this.toggleSkeletons(!0),this.elements.categoryGrid.innerHTML="",this.lastUpdatedMonthlyLabel="Загрузка данных…",this.lastUpdatedMonthlyDateLabel="Загрузка данных…",this.updateLastUpdatedPills(),this.elements.sumPlanned.textContent="…",this.elements.sumFact.textContent="…",this.elements.sumDelta.textContent="…",this.updateSummaryProgress(null,"…"),this.updateDailyAverage(null,0),this.setActiveCategoryTitle("Загрузка..."),this.elements.workEmptyState.style.display="none",this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows(),this.elements.pdfButton.disabled=!0,this.updateContractCard(null)}handleLoadError(){this.toggleSkeletons(!1),this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent="Ошибка загрузки данных",this.lastUpdatedMonthlyLabel="Ошибка загрузки данных",this.lastUpdatedMonthlyDateLabel="",this.updateLastUpdatedPills(),this.elements.sumPlanned.textContent="–",this.elements.sumFact.textContent="–",this.elements.sumDelta.textContent="–",this.elements.sumDelta.classList.remove("positive","negative"),this.summaryDailyRevenue=[],this.dailyRevenue=[],this.updateSummaryProgress(null,"–"),this.updateDailyAverage(null,0),this.updateContractCard(null),this.setActiveCategoryTitle("Смета не выбрана"),this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows(),this.elements.pdfButton.disabled=!0,this.elements.categoryGrid.innerHTML='<div class="empty-state">Ошибка загрузки данных</div>'}applyData(t){this.dataManager.setCurrentData(t),this.toggleSkeletons(!1);const e=Array.isArray(t.items)?t.items:[];this.groupedCategories=this.dataManager.buildCategories(e),this.ensureActiveCategory();const a=t.has_data?P(t.last_updated):"Нет данных",n=t.has_data?p(t.last_updated,{day:"2-digit",month:"2-digit",year:"numeric"}):"Нет данных";this.lastUpdatedMonthlyLabel=a,this.lastUpdatedMonthlyDateLabel=n,this.updateLastUpdatedPills();const i=t.has_data&&e.length>0;this.elements.pdfButton.disabled=!i,this.renderSummary(),this.renderCategories(),this.renderWorkList()}ensureActiveCategory(){this.activeCategoryKey&&this.groupedCategories.some(t=>t.key===this.activeCategoryKey)||(this.activeCategoryKey=this.groupedCategories.length?this.groupedCategories[0].key:null)}renderSummary(){const t=this.dataManager.getCurrentData(),e=t&&t.has_data?this.dataManager.calculateMetrics(t):null,a=this.dataManager.calculateContractMetrics(t||{});this.updateContractCard(a),this.metrics=e;const{summaryDailyRevenue:n,averageDailyRevenue:i,completion:o,completionLabel:l}=kt({metrics:e,elements:this.elements});this.summaryDailyRevenue=n||[],this.dailyRevenue=[...this.summaryDailyRevenue],this.updateSummaryProgress(o,l),this.updateDailyAverage(i,this.summaryDailyRevenue.length)}updateSummaryProgress(t,e){St({completion:t,label:e,elements:this.elements})}updateLastUpdatedPills(){const t=this.lastUpdatedMonthlyLabel||"Нет данных",e=this.lastUpdatedMonthlyDateLabel||t,a=this.lastUpdatedDailyLabel||t,n=this.lastUpdatedDailyDateLabel||a;this.elements.lastUpdatedText&&(this.elements.lastUpdatedText.textContent=t),this.elements.lastUpdatedTextDaily&&(this.elements.lastUpdatedTextDaily.textContent=a),this.viewMode==="daily"?this.updateContractTitleDate(n):this.updateContractTitleDate(e)}updateContractTitleDate(t){this.elements.contractTitleDate&&(this.elements.contractTitleDate.textContent=t?`на ${t}`:"")}updateContractCard(t){Dt({contractMetrics:t,elements:this.elements,formatMoneyFn:e=>y(e),formatPercentFn:e=>C(e)})}updateContractProgress(t){updateContractProgress({completion:t,elements:this.elements})}updateDailyAverage(t,e){const a=this.isCurrentMonth(this.selectedMonthIso);bt({averageValue:t,daysWithData:e,isCurrentMonth:a,elements:this.elements})}setDaySelectValue(t){!this.elements.daySelect||!t||(this.elements.daySelect.value=t,this.selectedDayIso=this.elements.daySelect.value||t)}showDailyLoadingState(){!this.elements.dailySkeleton||!this.elements.dailyTable||!this.elements.dailyEmptyState||(this.elements.dailySkeleton.style.display="block",this.elements.dailyTable.style.display="none",this.elements.dailyEmptyState.style.display="none",this.lastUpdatedDailyLabel="Загрузка данных…",this.lastUpdatedDailyDateLabel="",this.updateLastUpdatedPills())}handleDailyLoadError(t="Ошибка загрузки данных"){this.elements.dailySkeleton&&(this.elements.dailySkeleton.style.display="none"),this.showDailyEmptyState(t),this.lastUpdatedDailyLabel=t,this.lastUpdatedDailyDateLabel="",this.updateLastUpdatedPills()}showDailyEmptyState(t){!this.elements.dailyEmptyState||!this.elements.dailyTable||(this.elements.dailyEmptyState.textContent=t,this.elements.dailyEmptyState.style.display="block",this.elements.dailyTable.style.display="none")}applyDailyData(t){this.currentDailyData=t,yt({data:t,elements:this.elements,onAfterRender:()=>{this.lastUpdatedDailyLabel=t!=null&&t.has_data?P(t.last_updated):"Нет данных",this.lastUpdatedDailyDateLabel=t!=null&&t.has_data?p(t.last_updated,{day:"2-digit",month:"2-digit",year:"numeric"}):this.lastUpdatedDailyLabel,this.updateLastUpdatedPills(),requestAnimationFrame(()=>this.updateDailyNameCollapsers())}})}async loadDailyData(t){if(!t){this.handleDailyLoadError("Выберите день, чтобы загрузить данные");return}this.selectedDayIso=t,this.setDaySelectValue(t);const e=this.dataManager.getCachedDaily(t);e?this.applyDailyData(e):this.showDailyLoadingState();try{const{data:a}=await this.dataManager.fetchDailyReport(t,{force:!!e});this.applyDailyData(a),this.announce(`Данные за ${p(t,{day:"2-digit",month:"long"})} обновлены.`)}catch(a){console.error(a),e?this.announce("Не удалось обновить данные дня"):this.handleDailyLoadError()}}openDailyModal(){if(!this.summaryDailyRevenue.length||!this.elements.dailyModal||!this.isCurrentMonth(this.selectedMonthIso))return;const t=this.elements.dailyModal.querySelector("#daily-modal-title")||document.getElementById("daily-modal-title");t&&(t.textContent="Среднедневная выручка");const e=this.getSelectedMonthLabel()||"выбранный месяц";this.elements.dailyModalSubtitle&&(this.elements.dailyModalSubtitle.textContent=`По дням за ${e.toLowerCase()}`),this.dailyRevenue=[...this.summaryDailyRevenue],this.dailyModalMode="average",this.renderDailyModalList(),this.elements.dailyModal.classList.add("visible"),this.elements.dailyModal.setAttribute("aria-hidden","false")}async openWorkModal(t){if(!t||!this.elements.dailyModal||!this.isCurrentMonth(this.selectedMonthIso))return;const e=(t.work_name||t.description||"").toString(),a=this.selectedMonthIso,n=this.dataManager&&this.dataManager.apiUrl?this.dataManager.apiUrl.replace(/\/$/,""):"/api/dashboard",i=new URL(`${n}/work-breakdown`,window.location.origin);i.searchParams.set("month",a),i.searchParams.set("work",e);try{const o=this.elements.dailyModal.querySelector("#daily-modal-title")||document.getElementById("daily-modal-title");o&&(o.textContent=`Расшифровка: ${e}`),this.elements.dailyModalSubtitle&&(this.elements.dailyModalSubtitle.textContent="");const l=await fetch(i.toString(),{headers:this.visitorTracker?this.visitorTracker.buildHeaders():{}});if(!l.ok)throw new Error("HTTP "+l.status);const r=await l.json(),c=Array.isArray(r)?r:(r==null?void 0:r.daily)||[];this.dailyModalMode="work",this.dailyRevenue=(c||[]).map(d=>{const h=d.date||d.work_date||d.day,u=d.amount??d.total_volume??d.value,m=u==null?null:Number(u),f=d.unit||"",g=d.total_amount??null;return!h||m===null||!Number.isFinite(m)?null:{date:h,amount:m,unit:f,total_amount:g}}).filter(Boolean),this.renderDailyModalList(),this.elements.dailyModal.classList.add("visible"),this.elements.dailyModal.setAttribute("aria-hidden","false")}catch(o){console.error("Ошибка загрузки расшифровки по работе:",o),T("Не удалось загрузить расшифровку по работе.","error")}}closeDailyModal(){this.elements.dailyModal&&(this.elements.dailyModal.classList.remove("visible"),this.elements.dailyModal.setAttribute("aria-hidden","true"))}renderDailyModalList(){if(!this.elements.dailyModalList||!this.elements.dailyModalEmpty)return;const t=this.getSelectedMonthLabel()||"выбранный месяц";this.elements.dailyModalSubtitle&&(this.elements.dailyModalSubtitle.textContent=`По дням за ${t.toLowerCase()}`),this.elements.dailyModalList.innerHTML="";const e=[...this.dailyRevenue].sort((o,l)=>new Date(o.date)-new Date(l.date));if(!e.length){this.elements.dailyModalEmpty.style.display="block",this.elements.dailyModalList.style.display="none";return}this.elements.dailyModalEmpty.style.display="none",this.elements.dailyModalList.style.display="grid";const a=this.dailyModalMode==="work"||e.some(o=>o.unit||o.total_amount!==null&&o.total_amount!==void 0),n=document.createElement("div");n.className="modal-row modal-row-header",a?n.innerHTML=`
          <div class="modal-row-date">Дата</div>
          <div class="modal-row-value"><span class="modal-value-number">Объем</span></div>
          <div class="modal-row-sum">Сумма,₽</div>
        `:n.innerHTML=`
          <div class="modal-row-date">Дата</div>
          <div class="modal-row-sum">Сумма, ₽</div>
        `,this.elements.dailyModalList.appendChild(n);const i=document.createDocumentFragment();e.forEach(o=>{const l=document.createElement("div");l.className="modal-row";const c=(typeof window<"u"&&window.matchMedia?window.matchMedia("(max-width: 767px)").matches:!1)?p(o.date,{day:"2-digit",month:"2-digit"}):p(o.date);if(a){const d=Number(o.amount),h=Number.isFinite(d)?d.toFixed(1):"–",u=o.unit||"",m=Number(o.total_amount),f=Number.isFinite(m)?m.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}):"–";l.innerHTML=`
          <div class="modal-row-date">${c}</div>
          <div class="modal-row-value">
            <span class="modal-value-number">${Number.isFinite(d),h}</span>
            ${u?`<span class="modal-value-unit">(${u})</span>`:""}
          </div>
          <div class="modal-row-sum">${f}</div>
        `}else{const d=Number(o.amount),h=Number.isFinite(d)?d.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}):"–";l.innerHTML=`
          <div class="modal-row-date">${c}</div>
          <div class="modal-row-sum">${h}</div>
        `}i.appendChild(l)}),this.elements.dailyModalList.appendChild(i)}renderCategories(){Pt({groupedCategories:this.groupedCategories,activeCategoryKey:this.activeCategoryKey,elements:this.elements,colors:Tt,onSelect:t=>{this.activeCategoryKey=t,this.renderCategories(),this.renderWorkList()}}),this.enhanceAccessibility()}renderWorkList(){const t=this.dataManager.getCurrentData(),e=this.groupedCategories.find(n=>n.key===this.activeCategoryKey)||null;if(this.elements.workSortSelect&&(this.elements.workSortSelect.disabled=!e),!e){this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent=t&&!t.has_data?"Данные за выбранный месяц отсутствуют":"Здесь появится список работ выбранной сметы.",this.setActiveCategoryTitle("Смета не выбрана"),this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows();return}const a=[...e.works];if(this.sortWorks(a),this.setActiveCategoryTitle(`Расшифровка работ по смете «${e.title}»`,e.title),!a.length){this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent="В этой смете нет строк для отображения",this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows();return}this.elements.workEmptyState.style.display="none",this.elements.workList.classList.add("has-data"),this.workHeaderEl.hidden=!1,this.elements.workListScroller.style.display="block",this.renderWorkRows(a)}handleWorkSortChange(t){!t||this.workSort.column===t||(this.workSort.column=t,this.updateWorkSortButtons(),this.renderWorkList())}updateWorkSortButtons(){this.workSortButtons&&this.workSortButtons.forEach(t=>{const e=t.dataset.sort===this.workSort.column;t.classList.toggle("active",e),t.setAttribute("aria-pressed",String(e))}),this.elements.workSortSelect&&this.elements.workSortSelect.value!==this.workSort.column&&(this.elements.workSortSelect.value=this.workSort.column)}getSortValueForWork(t){if(!t)return Number.NEGATIVE_INFINITY;let e;switch(this.workSort.column){case"fact":e=t.fact_amount;break;case"delta":e=w(t);break;case"planned":default:e=t.planned_amount??t.fact_amount;break}const a=Number(e);return Number.isFinite(a)?a:Number.NEGATIVE_INFINITY}sortWorks(t){return Array.isArray(t)?this.workSort.column==="delta"?(t.sort((e,a)=>{const n=w(e),i=w(a),o=n<0,l=i<0;if(o!==l)return o?-1:1;if(o&&l){const d=n-i;if(d!==0)return d}else{const d=i-n;if(d!==0)return d}const r=((e==null?void 0:e.work_name)||(e==null?void 0:e.description)||"").toLowerCase(),c=((a==null?void 0:a.work_name)||(a==null?void 0:a.description)||"").toLowerCase();return r.localeCompare(c)}),t):(t.sort((e,a)=>{const n=this.getSortValueForWork(e),o=this.getSortValueForWork(a)-n;if(o!==0)return o;const l=((e==null?void 0:e.work_name)||(e==null?void 0:e.description)||"").toLowerCase(),r=((a==null?void 0:a.work_name)||(a==null?void 0:a.description)||"").toLowerCase();return l.localeCompare(r)}),t):t}initializeNameToggle(t){if(!t)return;const e=t.querySelector(".work-row-name-toggle");e&&(t.dataset.expanded="false",e.addEventListener("click",()=>{const a=t.classList.toggle("work-row-name--expanded");a?t.classList.remove("work-row-name--collapsed"):t.classList.add("work-row-name--collapsed"),t.dataset.expanded=String(a),e.setAttribute("aria-expanded",String(a)),e.setAttribute("aria-label",a?"Свернуть название":"Развернуть полное название")}))}updateNameCollapsers(t){if(!t)return;t.querySelectorAll(".work-row-name").forEach(a=>{const n=a.querySelector(".work-row-name-text"),i=a.querySelector(".work-row-name-toggle");if(!n||!i)return;const o=a.dataset.expanded==="true";a.classList.toggle("work-row-name--expanded",o),o?a.classList.remove("work-row-name--collapsed"):a.classList.add("work-row-name--collapsed"),i.setAttribute("aria-expanded",String(o)),i.setAttribute("aria-label",o?"Свернуть название":"Развернуть полное название"),a.classList.remove("work-row-name--collapsible"),i.hidden=!0;const l=parseFloat(window.getComputedStyle(n).lineHeight||"0"),r=l&&!Number.isNaN(l)?l*2:null;(r?n.scrollHeight>r+1:n.scrollHeight>n.offsetHeight+1)?(a.classList.add("work-row-name--collapsible"),i.hidden=!1):o||a.classList.remove("work-row-name--collapsed")})}updateDailyNameCollapsers(){this.updateNameCollapsers(this.elements.dailyTable)}createWorkRow(t,e,a){const n=t.work_name||t.description||"Без названия",i=w(t),o=i>0?"delta-positive":i<0?"delta-negative":"",l=y(t.planned_amount),r=y(t.fact_amount),c=y(i),d=document.createElement("div");return d.className="work-row",e===a-1&&d.classList.add("work-row-last"),d.innerHTML=`
      <div class="work-row-name work-row-name--collapsed" data-expanded="false">
        <span class="work-row-name-text">${n}</span>
        <button
          type="button"
          class="work-row-name-toggle"
          aria-expanded="false"
          aria-label="Развернуть полное название"
        >
          <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
        </button>
      </div>
      <div class="work-row-money work-row-plan">
        <span class="work-row-label">План</span>
        <span>${l}</span>
      </div>
      <div class="work-row-money work-row-fact">
        <span class="work-row-label">Факт</span>
        <span>${r}</span>
      </div>
      <div class="work-row-delta ${o}">
        <span class="work-row-label">Отклонение</span>
        <span class="work-row-delta-value">${c}</span>
      </div>
    `,this.initializeNameToggle(d.querySelector(".work-row-name")),d.addEventListener("click",h=>{if(!h.target.closest(".work-row-name-toggle"))try{this.openWorkModal(t)}catch(u){console.error(u)}}),d}updateWorkNameCollapsers(){this.updateNameCollapsers(this.elements.workListScroller)}getSelectedMonthLabel(){const t=this.elements.monthSelect.options[this.elements.monthSelect.selectedIndex];return t?t.textContent.trim():""}async downloadPdfReport(t){if(t.preventDefault(),this.elements.pdfButton.disabled)return;const a=(this.getSelectedMonthLabel()||this.elements.monthSelect.value||"period").toString().trim().replace(/\s+/g,"-").replace(/[^0-9A-Za-zА-Яа-я\-]+/g,"").replace(/-+/g,"-").replace(/^-|-$/g,""),n=a?`mad-podolsk-otchet-${a}.pdf`:"mad-podolsk-otchet.pdf";this.elements.pdfButton.disabled=!0,this.elements.pdfButton.innerHTML="Формируем PDF…";try{const i=new URL(this.apiPdfUrl,window.location.origin);i.searchParams.set("month",this.elements.monthSelect.value);const o=await fetch(i.toString(),{headers:{Accept:"application/pdf",...this.visitorTracker?this.visitorTracker.buildHeaders():{}}});if(!o.ok)throw new Error("HTTP "+o.status);const l=await o.blob(),r=URL.createObjectURL(l),c=document.createElement("a");c.href=r,c.download=n,c.style.display="none",document.body.appendChild(c),c.click(),c.remove(),setTimeout(()=>URL.revokeObjectURL(r),0),this.announce("PDF-отчёт сформирован.")}catch(i){console.error("PDF export error",i),T("Не удалось сформировать PDF. Попробуйте ещё раз позже.","error"),this.announce("Ошибка формирования PDF")}finally{this.elements.pdfButton.innerHTML=this.pdfButtonDefaultLabel,this.elements.pdfButton.disabled=!this.groupedCategories.length}}enhanceAccessibility(){this.elements.categoryGrid.querySelectorAll(".category-card").forEach((e,a)=>{var i,o;const n=((o=(i=e.querySelector(".category-title span"))==null?void 0:i.textContent)==null?void 0:o.trim())||`Смета ${a+1}`;e.setAttribute("role","button"),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",`Смета ${n}`),e.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),e.click())})})}createLiveRegion(){const t=document.createElement("div");return t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",document.body.appendChild(t),t}announce(t){this.liveRegion&&(this.liveRegion.textContent="",requestAnimationFrame(()=>{this.liveRegion.textContent=t}))}}function x(){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();const s=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()}function L(s,t){try{return s.getItem(t)}catch(e){return console.warn("Не удалось прочитать из хранилища",t,e),null}}function M(s,t,e){try{s.setItem(t,e)}catch(a){console.warn("Не удалось сохранить в хранилище",t,a)}}function U(s,t,{days:e=365}={}){try{const a=Math.max(1,Math.floor(e*24*60*60));document.cookie=`${s}=${encodeURIComponent(t)}; path=/; max-age=${a}`}catch(a){console.warn("Не удалось сохранить cookie",s,a)}}class Nt{constructor({userKey:t="mad_user_id",sessionKey:e="mad_session_id",sessionStartedAtKey:a="mad_session_started_at",visitLoggedKey:n="mad_visit_logged"}={}){this.userKey=t,this.sessionKey=e,this.sessionStartedAtKey=a,this.visitLoggedKey=n,this.userId=this.restoreUserId(),this.sessionId=this.restoreSessionId(),this.sessionStartedAt=this.restoreSessionStart(),this.visitLogged=this.restoreVisitLogged()}restoreUserId(){const e=(L(localStorage,this.userKey)||this.getCookieValue(this.userKey)||x()).trim();return M(localStorage,this.userKey,e),U(this.userKey,e,{days:365}),e}restoreSessionId(){const e=(L(sessionStorage,this.sessionKey)||this.getCookieValue(this.sessionKey)||x()).trim();return M(sessionStorage,this.sessionKey,e),U(this.sessionKey,e,{days:1}),e}restoreSessionStart(){const e=v(L(sessionStorage,this.sessionStartedAtKey))??Date.now();return M(sessionStorage,this.sessionStartedAtKey,String(e)),e}restoreVisitLogged(){return L(sessionStorage,this.visitLoggedKey)==="1"}getCookieValue(t){const e=document.cookie.match(new RegExp(`(?:^|; )${t}=([^;]*)`));return e?decodeURIComponent(e[1]):null}getSessionDurationSec(){const t=Date.now()-this.sessionStartedAt;return t>0?Math.round(t/1e3):0}buildHeaders(){const t={};this.userId&&(t["X-User-Id"]=this.userId),this.sessionId&&(t["X-Session-Id"]=this.sessionId);const e=this.getSessionDurationSec();return Number.isFinite(e)&&(t["X-Session-Duration-Sec"]=String(e)),t}markVisitLogged(){this.visitLogged=!0,M(sessionStorage,this.visitLoggedKey,"1")}async sendVisitLog({apiBase:t,endpoint:e}){if(!t||!e||this.visitLogged)return;const a={endpoint:e,user_id:this.userId,session_id:this.sessionId,session_duration_sec:this.getSessionDurationSec()};try{const n=(t||"").replace(/\/$/,"")||"/api";await fetch(`${n}/visit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),keepalive:!0}),this.markVisitLogged()}catch(n){console.warn("Не удалось отправить статистику визита",n)}}}const xt="/api/dashboard",Ut="/pdf",$t="/months",Ft="/days",It="/daily",Ht="(max-width: 767px)",Bt="Скачать PDF",Ot={page:".page",monthSelect:"#month",daySelect:"#day",monthControls:"#month-controls",dayControls:"#day-controls",lastUpdatedText:"#last-updated-text",lastUpdatedTextDaily:"#last-updated-text-daily",sumPlanned:"#sum-planned",sumFact:"#sum-fact",sumDelta:"#sum-delta",sumFactProgress:"#sum-fact-progress",sumFactProgressLabel:"#sum-fact-progress-label",sumDailyAverage:"#sum-daily-average",dailyAverageNote:"#daily-average-note",dailyAverageHint:"#daily-average-hint",dailyAverageCard:"#daily-average-card",dailyModal:"#daily-modal",dailyModalClose:"#daily-modal-close",dailyModalList:"#daily-modal-list",dailyModalEmpty:"#daily-modal-empty",dailyModalSubtitle:"#daily-modal-subtitle",summaryGrid:"#summary-grid",summarySkeleton:"#summary-skeleton",categoryGrid:"#category-grid",categorySkeleton:"#category-skeleton",workList:"#work-list",workSkeleton:"#work-skeleton",workEmptyState:"#work-empty-state",workSortSelect:"#work-sort-select",activeCategoryTitle:"#active-category-title",activeCategoryTitleDesktop:"#active-category-title-desktop",activeCategoryTitleMobileValue:"#active-category-title-mobile-value",workDetailHint:"#work-detail-hint",pdfButton:"#download-pdf",pdfButtonContainerDesktop:".pdf-action-desktop",pdfButtonContainerMobile:".pdf-action-mobile",contractCard:"#contract-card",contractAmount:"#contract-amount",contractExecuted:"#contract-executed",contractPercent:"#contract-percent",contractProgress:"#contract-progress",contractTitleDate:"#contract-title-date",viewModeMonthly:"#tab-monthly",viewModeDaily:"#tab-daily",dailyPanel:"#daily-panel",dailySkeleton:"#daily-skeleton",dailyEmptyState:"#daily-empty-state",dailyTable:"#daily-table",dailyPanelTitle:"#daily-panel-title",dailyPanelSubtitle:"#daily-panel-subtitle"},A=(()=>{const s=document.querySelector('meta[name="mad-api-url"]');return((s==null?void 0:s.content)||window.MAD_API_URL||"").trim()||xt})(),S=A.replace(/\/$/,""),Wt=`${S}${Ut}`,Gt=`${S}${$t}`,Kt=`${S}${Ft}`,Vt=`${S}${It}`;function qt(){const s=new Nt,t=Y(Ot),e=t.pdfButton?t.pdfButton.innerHTML:Bt;j({pdfButton:t.pdfButton,workSortSelect:t.workSortSelect},!0);const a=window.matchMedia(Ht),n=r=>{if(!t.pdfButton||!t.pdfButtonContainerDesktop||!t.pdfButtonContainerMobile)return;const c=r?t.pdfButtonContainerMobile:t.pdfButtonContainerDesktop;t.pdfButton.parentElement!==c&&c.appendChild(t.pdfButton)};n(a.matches),a.addEventListener("change",r=>n(r.matches));const i=new ct(A,{monthsUrl:Gt,daysUrl:Kt,dailyUrl:Vt,visitorTracker:s});new Rt({dataManager:i,elements:t,apiPdfUrl:Wt,pdfButtonDefaultLabel:e,visitorTracker:s}).init();const l=new URL(A,window.location.origin).pathname;s.sendVisitLog({apiBase:S,endpoint:l})}document.addEventListener("DOMContentLoaded",()=>{qt()});
