(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();function B(o){return Object.fromEntries(Object.entries(o).map(([e,t])=>[e,document.querySelector(t)]))}function y(o){return o==null||isNaN(o)?"–":o.toLocaleString("ru-RU",{maximumFractionDigits:0})}function g(o){const e=y(o);return e==="–"?e:`${e} ₽`}function E(o){return o==null||isNaN(o)?"–":(o*100).toFixed(1)+" %"}function T(o){return o?new Date(o).toLocaleString("ru-RU"):"—"}function f(o,e={day:"2-digit",month:"long"}){if(!o)return"—";const t=new Date(o);return Number.isNaN(t.getTime())?"—":t.toLocaleDateString("ru-RU",e)}function I(o,e={maximumFractionDigits:3}){if(o==null||Number.isNaN(o))return"–";const t={minimumFractionDigits:0,...e};return Number(o).toLocaleString("ru-RU",t)}function N(o,e="success"){const t=document.createElement("div");t.className=`toast ${e}`,t.textContent=o,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideIn 0.3s ease reverse",setTimeout(()=>t.remove(),300)},3e3)}function w(o){if(o.delta_amount!==null&&o.delta_amount!==void 0)return o.delta_amount;const e=o.planned_amount??0;return(o.fact_amount??0)-e}function O(o,e){let t;return(...s)=>{clearTimeout(t),t=setTimeout(()=>o(...s),e)}}function v(o){if(o==null)return null;const e=typeof o=="number"?o:Number(o);return Number.isFinite(e)?e:null}function K(o,e=!0){Object.values(o).forEach(t=>{t&&typeof t.disabled=="boolean"&&(t.disabled=e)})}const W={внерегл_ч_1:{key:"внерегламент",title:"внерегламент"},внерегл_ч_2:{key:"внерегламент",title:"внерегламент"}},V=new Set([408,425,429,500,502,503,504]),k=700;function x(o){const e=v(o);return e!==null&&e!==0}function q(o){return o?x(o.planned_amount)||x(o.fact_amount):!1}function G(o,e){const t=(o||"").trim(),s=W[t.toLowerCase()];if(s)return{...s};const a=(e||"").trim(),n=t||a||"Прочее";return{key:n,title:a||n}}async function z(o=k){return new Promise(e=>setTimeout(e,o))}function D(o){const e=new Error("HTTP "+o.status);return e.retryable=V.has(o.status),e}function j(o){if(!o)return!1;if(o.retryable===!0)return!0;if(o.retryable===!1)return!1;const e=(o.message||"").toLowerCase();return o.name==="TypeError"||e.includes("network")||e.includes("timeout")||e.includes("timed out")||e.includes("connection")}async function S(o,{retries:e=1,delayMs:t=k}={}){let s;for(let a=0;a<=e;a+=1)try{return await o()}catch(n){if(s=n,a===e||!j(n))break;await z(t)}throw s}class Y{constructor(e,{monthsUrl:t,daysUrl:s,dailyUrl:a,visitorTracker:n}={}){this.apiUrl=e,this.monthsUrl=t||`${e.replace(/\/$/,"")}/months`,this.daysUrl=s||`${e.replace(/\/$/,"")}/days`,this.dailyUrl=a||`${e.replace(/\/$/,"")}/daily`,this.cache=new Map,this.dailyCache=new Map,this.currentData=null,this.visitorTracker=n||null}getCached(e){return this.cache.get(e)||null}async fetchData(e,{force:t=!1}={}){if(!e)throw new Error("Не указан месяц для загрузки данных дашборда");if(!t&&this.cache.has(e))return{data:this.cache.get(e),fromCache:!0};const s=new URL(this.apiUrl,window.location.origin);s.searchParams.set("month",e),s.searchParams.set("_",Date.now().toString());const a={"Cache-Control":"no-cache",Pragma:"no-cache",...this.visitorTracker?this.visitorTracker.buildHeaders():{}},i=await(await S(()=>fetch(s.toString(),{cache:"no-store",headers:a}).then(l=>{if(!l.ok)throw D(l);return l}),{delayMs:k})).json();return this.cache.set(e,i),{data:i,fromCache:!1}}async fetchAvailableMonths(){const t=await(await S(()=>fetch(this.monthsUrl,{cache:"no-store",headers:this.visitorTracker?this.visitorTracker.buildHeaders():void 0}).then(s=>{if(!s.ok)throw D(s);return s}),{delayMs:k})).json();return Array.isArray(t==null?void 0:t.months)?t.months:[]}async fetchAvailableDays(){const t=await(await S(()=>fetch(this.daysUrl,{cache:"no-store",headers:this.visitorTracker?this.visitorTracker.buildHeaders():void 0}).then(s=>{if(!s.ok)throw D(s);return s}),{delayMs:k})).json();return Array.isArray(t==null?void 0:t.days)?t.days:[]}getCachedDaily(e){return this.dailyCache.get(e)||null}async fetchDailyReport(e,{force:t=!1}={}){if(!e)throw new Error("Не указана дата для загрузки дневного отчёта");if(!t&&this.dailyCache.has(e))return{data:this.dailyCache.get(e),fromCache:!0};const s=new URL(this.dailyUrl,window.location.origin);s.searchParams.set("day",e),s.searchParams.set("_",Date.now().toString());const a={"Cache-Control":"no-cache",Pragma:"no-cache",...this.visitorTracker?this.visitorTracker.buildHeaders():{}},i=await(await S(()=>fetch(s.toString(),{cache:"no-store",headers:a}).then(l=>{if(!l.ok)throw D(l);return l}),{delayMs:k})).json();return this.dailyCache.set(e,i),{data:i,fromCache:!1}}setCurrentData(e){this.currentData=e}getCurrentData(){return this.currentData}summarizeItems(e=[]){return e.reduce((t,s)=>(s.planned_amount!==null&&s.planned_amount!==void 0&&(t.planned+=s.planned_amount,t.hasPlanned=!0),s.fact_amount!==null&&s.fact_amount!==void 0&&(t.fact+=s.fact_amount,t.hasFact=!0),t),{planned:0,fact:0,hasPlanned:!1,hasFact:!1})}calculateMetrics(e){if(!e)return null;const t=e.items||[],s=this.summarizeItems(t),a=e.summary||{},n=a.planned_amount??(s.hasPlanned?s.planned:null),i=a.fact_amount??(s.hasFact?s.fact:null),l=a.completion_pct??(n?(i??0)/n:null),d=a.delta_amount!==null&&a.delta_amount!==void 0?a.delta_amount:n!==null||i!==null?(i??0)-(n??0):null,c=Array.isArray(a.daily_revenue)?a.daily_revenue.map(h=>{const m=v((h==null?void 0:h.amount)??(h==null?void 0:h.fact_total)??(h==null?void 0:h.value)),p=(h==null?void 0:h.date)||(h==null?void 0:h.work_date)||(h==null?void 0:h.day);return!p||m===null?null:{date:p,amount:m}}).filter(Boolean):[],u=v(a.average_daily_revenue)??(c.length?c.reduce((h,m)=>h+m.amount,0)/c.length:null);return{planned:n,fact:i,completion:l,delta:d,dailyRevenue:c,averageDailyRevenue:u}}calculateContractMetrics(e){if(!e||!e.summary)return null;const t=e.summary,s=v(t.contract_amount),a=v(t.contract_executed),n=t.contract_completion_pct??(s?(a??0)/s:null);return{contractAmount:s,executed:a,completion:n}}buildCategories(e=[]){const t=new Map;return e.forEach(s=>{if(!q(s))return;const a=s.category||s.smeta||"",n=a?a.trim():"";if(!n||n.toLowerCase()==="без категории")return;const{key:i,title:l}=G(n,s.smeta);t.has(i)||t.set(i,{key:i,title:l,works:[],planned:0,fact:0,delta:0});const r=t.get(i);!r.title&&l&&(r.title=l),s.category_plan_only===!0||r.works.push(s);const c=s.planned_amount??0,u=s.fact_amount??0,h=w(s);isNaN(c)||(r.planned+=c),isNaN(u)||(r.fact+=u),isNaN(h)||(r.delta+=h)}),Array.from(t.values()).sort((s,a)=>{const n=isNaN(s.planned)?0:s.planned,i=isNaN(a.planned)?0:a.planned;if(n===i){const l=(s.title||"").toLowerCase(),r=(a.title||"").toLowerCase();return l.localeCompare(r,"ru")}return i-n})}}const _=[{accent:"#22c55e",soft:"rgba(34, 197, 94, 0.25)"},{accent:"#2563eb",soft:"rgba(37, 99, 235, 0.25)"},{accent:"#f97316",soft:"rgba(249, 115, 22, 0.25)"},{accent:"#dc2626",soft:"rgba(220, 38, 38, 0.25)"},{accent:"#a855f7",soft:"rgba(168, 85, 247, 0.25)"},{accent:"#0f766e",soft:"rgba(15, 118, 110, 0.25)"}];class X{constructor({dataManager:e,elements:t,apiPdfUrl:s,pdfButtonDefaultLabel:a,visitorTracker:n}){this.dataManager=e,this.elements=t,this.apiPdfUrl=s,this.pdfButtonDefaultLabel=a,this.visitorTracker=n||null,this.groupedCategories=[],this.activeCategoryKey=null,this.workHeaderEl=null,this.liveRegion=null,this.metrics=null,this.lastUpdatedMonthlyLabel=null,this.lastUpdatedMonthlyDateLabel=null,this.lastUpdatedDailyLabel=null,this.lastUpdatedDailyDateLabel=null,this.summaryDailyRevenue=[],this.dailyRevenue=[],this.workSort={column:"planned"},this.selectedMonthIso=null,this.selectedDayIso=null,this.availableDays=[],this.initialMonth=new URLSearchParams(window.location.search).get("month"),this.viewMode="monthly",this.dayOptionsLoaded=!1,this.currentDailyData=null,this.elements.workSortSelect&&(this.elements.workSortSelect.value=this.workSort.column),this.handleResize=O(()=>{this.updateWorkNameCollapsers(),this.updateDailyNameCollapsers()},150),this.monthOptionsLoaded=!1}setActiveCategoryTitle(e,t=e){this.elements.activeCategoryTitleDesktop?this.elements.activeCategoryTitleDesktop.textContent=e:this.elements.activeCategoryTitle&&(this.elements.activeCategoryTitle.textContent=e),this.elements.activeCategoryTitleMobileValue&&(this.elements.activeCategoryTitleMobileValue.textContent=t)}init(){this.prepareWorkList(),this.liveRegion=this.createLiveRegion(),this.bindEvents(),this.elements.workDetailHint&&(this.elements.workDetailHint.hidden=!0),this.updateViewModeLayout(),this.initMonthSelect(),window.addEventListener("resize",this.handleResize)}toggleSkeletons(e){this.elements.summarySkeleton&&(this.elements.summarySkeleton.style.display=e?"grid":"none"),this.elements.categorySkeleton&&(this.elements.categorySkeleton.style.display=e?"grid":"none"),this.elements.workSkeleton&&(this.elements.workSkeleton.style.display=e?"block":"none"),this.elements.summaryGrid&&(this.elements.summaryGrid.hidden=e),this.elements.categoryGrid&&(this.elements.categoryGrid.style.display=e?"none":""),this.elements.workList&&(this.elements.workList.style.display=e?"none":"")}updateViewModeLayout(){this.elements.page&&(this.elements.page.dataset.viewMode=this.viewMode),this.elements.viewModeMonthly&&(this.elements.viewModeMonthly.classList.toggle("is-active",this.viewMode==="monthly"),this.elements.viewModeMonthly.setAttribute("aria-selected",this.viewMode==="monthly"?"true":"false")),this.elements.viewModeDaily&&(this.elements.viewModeDaily.classList.toggle("is-active",this.viewMode==="daily"),this.elements.viewModeDaily.setAttribute("aria-selected",this.viewMode==="daily"?"true":"false"));const e=this.viewMode==="daily";this.elements.pdfButton&&(this.elements.pdfButton.disabled=e||!this.groupedCategories.length),this.updateLastUpdatedPills()}prepareWorkList(){this.workHeaderEl=document.createElement("div"),this.workHeaderEl.className="work-row work-row-header",this.workHeaderEl.innerHTML=`
      <div>Работа</div>
      <div>
        <button type="button" class="work-sort-button" data-sort="planned">
          <span>План, ₽</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по плану (по убыванию)</span>
        </button>
      </div>
      <div>
        <button type="button" class="work-sort-button" data-sort="fact">
          <span>Факт, ₽</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по факту (по убыванию)</span>
        </button>
      </div>
      <div>
        <button type="button" class="work-sort-button" data-sort="delta">
          <span>Отклонение</span>
          <span class="sort-indicator" aria-hidden="true"></span>
          <span class="sr-only">Сортировка по отклонению (по убыванию)</span>
        </button>
      </div>
    `,this.workHeaderEl.hidden=!0,this.elements.workList.appendChild(this.workHeaderEl),this.workSortButtons=Array.from(this.workHeaderEl.querySelectorAll(".work-sort-button")),this.workSortButtons.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.sort;this.handleWorkSortChange(t)})}),this.updateWorkSortButtons(),this.elements.workListScroller=document.createElement("div"),this.elements.workListScroller.className="work-list-scroller",this.elements.workList.appendChild(this.elements.workListScroller),this.elements.workListScroller.style.display="none"}clearWorkRows(){this.elements.workListScroller&&(this.elements.workListScroller.innerHTML="")}renderWorkRows(e){if(this.clearWorkRows(),!Array.isArray(e)||!e.length)return;const t=document.createDocumentFragment();e.forEach((s,a)=>{const n=this.createWorkRow(s,a,e.length);n&&t.appendChild(n)}),this.elements.workListScroller.appendChild(t),requestAnimationFrame(()=>this.updateWorkNameCollapsers())}bindEvents(){this.elements.workSortSelect&&this.elements.workSortSelect.addEventListener("change",e=>{const t=e.target.value;this.handleWorkSortChange(t)}),this.elements.pdfButton.addEventListener("click",e=>this.downloadPdfReport(e)),this.elements.dailyAverageCard&&this.elements.dailyAverageCard.addEventListener("click",()=>this.openDailyModal()),this.elements.dailyModalClose&&this.elements.dailyModalClose.addEventListener("click",()=>this.closeDailyModal()),this.elements.dailyModal&&this.elements.dailyModal.addEventListener("click",e=>{e.target===this.elements.dailyModal&&this.closeDailyModal()}),this.elements.viewModeMonthly&&this.elements.viewModeMonthly.addEventListener("click",()=>this.switchViewMode("monthly")),this.elements.viewModeDaily&&this.elements.viewModeDaily.addEventListener("click",()=>this.switchViewMode("daily")),this.elements.daySelect&&this.elements.daySelect.addEventListener("change",()=>{this.loadDailyData(this.elements.daySelect.value)})}async initMonthSelect(){if(!this.elements.monthSelect)return;const e=this.elements.monthSelect;e.innerHTML="",e.disabled=!0;try{const s=(await this.dataManager.fetchAvailableMonths()||[]).map(n=>{if(!n)return null;const i=new Date(n);return Number.isNaN(i.getTime())?null:{iso:n,label:i.toLocaleDateString("ru-RU",{month:"long",year:"numeric"})}}).filter(Boolean);if(!s.length){const n=this.initialMonth||this.getCurrentMonthIso();this.setMonthSelectPlaceholder("Нет данных"),n?await this.loadMonthData(n):this.handleLoadError();return}const a=this.initialMonth&&s.some(n=>n.iso===this.initialMonth);s.forEach((n,i)=>{const l=document.createElement("option");l.value=n.iso,l.textContent=n.label,(a&&n.iso===this.initialMonth||!a&&i===0)&&(l.selected=!0),e.appendChild(l)}),this.monthOptionsLoaded||(e.addEventListener("change",()=>{this.loadMonthData(e.value)}),this.monthOptionsLoaded=!0),e.disabled=!1,this.loadMonthData(e.value||s[0].iso)}catch(t){console.error("Не удалось загрузить список месяцев",t),this.setMonthSelectPlaceholder("Ошибка загрузки"),this.handleLoadError()}}async initDaySelect(){var t;if(!this.elements.daySelect)return;const e=this.elements.daySelect;e.value="",e.disabled=!0,e.min="",e.max="",this.selectedDayIso=null;try{const s=await this.dataManager.fetchAvailableDays();if(this.availableDays=(s||[]).map(l=>{const r=new Date(l);return Number.isNaN(r.getTime())?null:{iso:r.toISOString().slice(0,10),label:f(r,{day:"2-digit",month:"long"})}}).filter(Boolean).sort((l,r)=>l.iso<r.iso?1:-1),!this.availableDays.length){const l=this.getCurrentDayIso();this.availableDays=l?[{iso:l,label:f(l,{day:"2-digit",month:"long"})}]:[]}const a=this.availableDays.reduce((l,r)=>!l||r.iso<l?r.iso:l,null),n=this.availableDays.reduce((l,r)=>!l||r.iso>l?r.iso:l,null);a&&(e.min=a),n&&(e.max=n);const i=this.selectedDayIso&&this.availableDays.some(l=>l.iso===this.selectedDayIso)?this.selectedDayIso:(t=this.availableDays[0])==null?void 0:t.iso;i&&(e.value=i,this.selectedDayIso=i),this.dayOptionsLoaded=!0,e.disabled=!1}catch(s){console.error("Не удалось загрузить список дней",s),e.value="",e.placeholder="Ошибка загрузки",e.setAttribute("aria-invalid","true"),this.dayOptionsLoaded=!1}}getCurrentMonthIso(){const e=new Date,t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0");return`${t}-${s}-01`}getCurrentDayIso(){const e=new Date,t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${a}`}getMonthKey(e){if(!e)return null;const t=/^(\d{4})-(\d{1,2})/.exec(e);if(t){const s=Number(t[1]),a=Number(t[2]);if(!Number.isNaN(s)&&a>=1&&a<=12)return`${s}-${a-1}`}return null}isCurrentMonth(e){const t=this.getMonthKey(e);if(!t)return!1;const s=new Date,a=`${s.getFullYear()}-${s.getMonth()}`;return t===a}async switchViewMode(e){var s;const t=e==="daily"?"daily":"monthly";if(this.viewMode!==t)if(this.viewMode=t,this.updateViewModeLayout(),t==="daily"){this.dayOptionsLoaded||await this.initDaySelect();const a=((s=this.elements.daySelect)==null?void 0:s.value)||this.selectedDayIso||(this.availableDays[0]?this.availableDays[0].iso:null)||this.getCurrentDayIso();a?(this.setDaySelectValue(a),await this.loadDailyData(a)):this.showDailyEmptyState("Нет данных за текущий месяц")}else this.updateLastUpdatedPills()}updateDailyAverageVisibility(e=this.selectedMonthIso){const t=this.isCurrentMonth(e);this.elements.dailyAverageNote&&(this.elements.dailyAverageNote.hidden=!t),this.elements.dailyAverageHint&&(this.elements.dailyAverageHint.hidden=!t),this.elements.workDetailHint&&(this.elements.workDetailHint.hidden=!t)}setMonthSelectPlaceholder(e){if(!this.elements.monthSelect)return;const t=document.createElement("option");t.value="",t.textContent=e,t.disabled=!0,t.selected=!0,this.elements.monthSelect.appendChild(t),this.elements.monthSelect.disabled=!0}async loadMonthData(e){this.selectedMonthIso=e,this.updateDailyAverageVisibility(e);const t=this.dataManager.getCached(e);t?this.applyData(t):this.showLoadingState();try{const{data:s}=await this.dataManager.fetchData(e,{force:!!t});this.applyData(s),this.announce(`Данные за ${this.getSelectedMonthLabel()||"выбранный месяц"} обновлены.`)}catch(s){console.error(s),t?this.announce("Не удалось обновить данные"):this.handleLoadError()}}showLoadingState(){this.groupedCategories=[],this.activeCategoryKey=null,this.summaryDailyRevenue=[],this.dailyRevenue=[],this.toggleSkeletons(!0),this.elements.categoryGrid.innerHTML="",this.lastUpdatedMonthlyLabel="Загрузка данных…",this.lastUpdatedMonthlyDateLabel="Загрузка данных…",this.updateLastUpdatedPills(),this.elements.sumPlanned.textContent="…",this.elements.sumFact.textContent="…",this.elements.sumDelta.textContent="…",this.updateSummaryProgress(null,"…"),this.updateDailyAverage(null,0),this.setActiveCategoryTitle("Загрузка..."),this.elements.workEmptyState.style.display="none",this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows(),this.elements.pdfButton.disabled=!0,this.updateContractCard(null)}handleLoadError(){this.toggleSkeletons(!1),this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent="Ошибка загрузки данных",this.lastUpdatedMonthlyLabel="Ошибка загрузки данных",this.lastUpdatedMonthlyDateLabel="",this.updateLastUpdatedPills(),this.elements.sumPlanned.textContent="–",this.elements.sumFact.textContent="–",this.elements.sumDelta.textContent="–",this.elements.sumDelta.classList.remove("positive","negative"),this.summaryDailyRevenue=[],this.dailyRevenue=[],this.updateSummaryProgress(null,"–"),this.updateDailyAverage(null,0),this.updateContractCard(null),this.setActiveCategoryTitle("Смета не выбрана"),this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows(),this.elements.pdfButton.disabled=!0,this.elements.categoryGrid.innerHTML='<div class="empty-state">Ошибка загрузки данных</div>'}applyData(e){this.dataManager.setCurrentData(e),this.toggleSkeletons(!1);const t=Array.isArray(e.items)?e.items:[];this.groupedCategories=this.dataManager.buildCategories(t),this.ensureActiveCategory();const s=e.has_data?T(e.last_updated):"Нет данных",a=e.has_data?f(e.last_updated,{day:"2-digit",month:"2-digit",year:"numeric"}):"Нет данных";this.lastUpdatedMonthlyLabel=s,this.lastUpdatedMonthlyDateLabel=a,this.updateLastUpdatedPills();const n=e.has_data&&t.length>0;this.elements.pdfButton.disabled=!n,this.renderSummary(),this.renderCategories(),this.renderWorkList(),this.renderPrintReport()}ensureActiveCategory(){this.activeCategoryKey&&this.groupedCategories.some(e=>e.key===this.activeCategoryKey)||(this.activeCategoryKey=this.groupedCategories.length?this.groupedCategories[0].key:null)}renderSummary(){const e=this.dataManager.getCurrentData(),t=e&&e.has_data?this.dataManager.calculateMetrics(e):null,s=this.dataManager.calculateContractMetrics(e||{});if(this.updateContractCard(s),this.metrics=t,!t){this.elements.sumPlanned.textContent="–",this.elements.sumFact.textContent="–",this.elements.sumDelta.textContent="–",this.elements.sumDelta.classList.remove("positive","negative"),this.summaryDailyRevenue=[],this.dailyRevenue=[],this.updateSummaryProgress(null,"–"),this.updateDailyAverage(null,0);return}this.summaryDailyRevenue=Array.isArray(t.dailyRevenue)?t.dailyRevenue:[],this.dailyRevenue=[...this.summaryDailyRevenue],this.elements.sumPlanned.textContent=y(t.planned),this.elements.sumFact.textContent=y(t.fact),this.elements.sumDelta.textContent=y(t.delta),this.elements.sumDelta.classList.remove("positive","negative"),t.delta>0&&this.elements.sumDelta.classList.add("positive"),t.delta<0&&this.elements.sumDelta.classList.add("negative");const a=t.completion!==null&&t.completion!==void 0?E(t.completion):"–";this.updateSummaryProgress(t.completion,a),this.updateDailyAverage(t.averageDailyRevenue,this.summaryDailyRevenue.length)}updateSummaryProgress(e,t){const s=e!=null&&!Number.isNaN(e)?Math.max(0,e*100):0,a=Math.min(115,s),n=Math.min(120,Math.max(0,s)),i=s>100?"#16a34a":`hsl(${n}, 78%, ${s>=50?43:47}%)`;this.elements.sumFactProgress&&(this.elements.sumFactProgress.style.width=`${a}%`,this.elements.sumFactProgress.classList.toggle("overflow",s>100),this.elements.sumFactProgress.style.setProperty("--progress-color",i)),this.elements.sumFactProgressLabel&&(this.elements.sumFactProgressLabel.textContent=t)}updateLastUpdatedPills(){const e=this.lastUpdatedMonthlyLabel||"Нет данных",t=this.lastUpdatedMonthlyDateLabel||e,s=this.lastUpdatedDailyLabel||e,a=this.lastUpdatedDailyDateLabel||s;this.elements.lastUpdatedText&&(this.elements.lastUpdatedText.textContent=e),this.elements.lastUpdatedTextDaily&&(this.elements.lastUpdatedTextDaily.textContent=s),this.viewMode==="daily"?this.updateContractTitleDate(a):this.updateContractTitleDate(t)}updateContractTitleDate(e){this.elements.contractTitleDate&&(this.elements.contractTitleDate.textContent=e?`на ${e}`:"")}updateContractCard(e){if(!this.elements.contractCard)return;const t=e&&e.contractAmount!==null&&e.executed!==null,s=t?e.completion:null,a=s!=null&&!Number.isNaN(s)?E(s):"–";this.elements.contractAmount&&(this.elements.contractAmount.textContent=t?y(e.contractAmount):"–"),this.elements.contractExecuted&&(this.elements.contractExecuted.textContent=t?y(e.executed):"–"),this.elements.contractPercent&&(this.elements.contractPercent.textContent=a),this.updateContractProgress(s)}updateContractProgress(e){if(!this.elements.contractProgress)return;const t=e!=null&&!Number.isNaN(e)?Math.max(0,e*100):0,s=Math.min(115,t),a=t>100,n=a?"#16a34a":"var(--accent)";this.elements.contractProgress.style.width=`${s}%`,this.elements.contractProgress.style.setProperty("--progress-color",n),this.elements.contractProgress.style.background=n,this.elements.contractProgress.classList.toggle("overflow",a),this.elements.contractProgress.parentElement&&this.elements.contractProgress.parentElement.setAttribute("aria-valuenow",Math.min(120,t).toFixed(1))}updateDailyAverage(e,t){const s=Number.isFinite(t)&&t>0,a=this.isCurrentMonth(this.selectedMonthIso),n=s&&a;if(this.elements.sumDailyAverage&&(this.elements.sumDailyAverage.textContent=e!=null&&!Number.isNaN(e)?y(e):"–"),this.elements.dailyAverageCard){this.elements.dailyAverageCard.classList.toggle("is-disabled",!n),this.elements.dailyAverageCard.setAttribute("aria-disabled",String(!n));const i=this.elements.dailyAverageCard.querySelector(".sr-only");i&&(i.hidden=!n)}}setDaySelectValue(e){!this.elements.daySelect||!e||(this.elements.daySelect.value=e,this.selectedDayIso=this.elements.daySelect.value||e)}showDailyLoadingState(){!this.elements.dailySkeleton||!this.elements.dailyTable||!this.elements.dailyEmptyState||(this.elements.dailySkeleton.style.display="block",this.elements.dailyTable.style.display="none",this.elements.dailyEmptyState.style.display="none",this.lastUpdatedDailyLabel="Загрузка данных…",this.lastUpdatedDailyDateLabel="",this.updateLastUpdatedPills())}handleDailyLoadError(e="Ошибка загрузки данных"){this.elements.dailySkeleton&&(this.elements.dailySkeleton.style.display="none"),this.showDailyEmptyState(e),this.lastUpdatedDailyLabel=e,this.lastUpdatedDailyDateLabel="",this.updateLastUpdatedPills()}showDailyEmptyState(e){!this.elements.dailyEmptyState||!this.elements.dailyTable||(this.elements.dailyEmptyState.textContent=e,this.elements.dailyEmptyState.style.display="block",this.elements.dailyTable.style.display="none")}applyDailyData(e){this.currentDailyData=e,this.elements.dailySkeleton&&(this.elements.dailySkeleton.style.display="none");const t=Array.isArray(e==null?void 0:e.items)?e.items:[];t.length?this.elements.dailyEmptyState&&(this.elements.dailyEmptyState.style.display="none"):this.showDailyEmptyState("Нет данных по выбранному дню");const s=f(e==null?void 0:e.date,{day:"2-digit",month:"long"}),a=s?`Данные за ${s}`:"Данные за выбранный день";if(this.elements.dailyPanelTitle&&(this.elements.dailyPanelTitle.textContent=a),this.elements.dailyPanelSubtitle){const n=s?"Данные доступны только для текущего месяца":"Выберите день, чтобы увидеть данные";this.elements.dailyPanelSubtitle.textContent=n,this.elements.dailyPanelSubtitle.hidden=!1}this.lastUpdatedDailyLabel=e!=null&&e.has_data?T(e.last_updated):"Нет данных",this.lastUpdatedDailyDateLabel=e!=null&&e.has_data?f(e.last_updated,{day:"2-digit",month:"2-digit",year:"numeric"}):this.lastUpdatedDailyLabel,this.updateLastUpdatedPills(),this.renderDailyTable(t)}renderDailyTable(e){if(!this.elements.dailyTable)return;if(this.elements.dailyTable.innerHTML="",!Array.isArray(e)||!e.length){this.showDailyEmptyState("Нет данных по выбранному дню");return}const t=[...e].sort((l,r)=>{const d=Number.isFinite(Number(l==null?void 0:l.total_amount))?Number(l.total_amount):0;return(Number.isFinite(Number(r==null?void 0:r.total_amount))?Number(r.total_amount):0)-d});this.elements.dailyTable.style.display="block",this.elements.dailyTable.classList.add("has-data");const s=document.createElement("div");s.className="work-row work-row-header",s.innerHTML=`
      <div>Смета</div>
      <div>Работы</div>
      <div>Ед. изм.</div>
      <div>Объём</div>
      <div>Сумма, ₽</div>
    `;const a=document.createDocumentFragment();a.appendChild(s),t.forEach((l,r)=>{const d=document.createElement("div");d.className="work-row daily-row",r===t.length-1&&d.classList.add("work-row-last"),d.innerHTML=`
        <div class="daily-cell daily-cell-smeta">${l.smeta||"—"}</div>
        <div class="daily-cell daily-cell-name">
          <div class="work-row-name work-row-name--collapsed" data-expanded="false">
            <span class="work-row-name-text">${l.description||"Без названия"}</span>
            <button
              type="button"
              class="work-row-name-toggle"
              aria-expanded="false"
              aria-label="Развернуть полное название"
            >
              <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="daily-cell daily-cell-unit">
          <span class="daily-cell-label">Ед. изм.</span>
          <span class="daily-cell-value">${l.unit||"—"}</span>
        </div>
        <div class="daily-cell daily-cell-volume">
          <span class="daily-cell-label">Объём</span>
          <span class="daily-cell-value"><strong>${I(l.total_volume,{maximumFractionDigits:3})}</strong></span>
        </div>
        <div class="daily-cell daily-cell-amount">
          <span class="daily-cell-label">Сумма</span>
          <span class="daily-cell-value"><strong>${g(l.total_amount)}</strong></span>
        </div>
      `,this.initializeNameToggle(d.querySelector(".work-row-name")),a.appendChild(d)});const n=t.reduce((l,r)=>{const d=Number(r.total_amount);return l+(Number.isFinite(d)?d:0)},0),i=document.createElement("div");i.className="work-row work-row-total daily-total-row",i.innerHTML=`
      <div class="daily-cell daily-cell-total-label">Итого по сумме</div>
      <div class="daily-cell daily-cell-total-gap"></div>
      <div class="daily-cell daily-cell-total-gap"></div>
      <div class="daily-cell daily-cell-total-gap"></div>
      <div class="daily-cell daily-cell-total-amount"><strong>${g(n)}</strong></div>
    `,a.appendChild(i),this.elements.dailyTable.appendChild(a),requestAnimationFrame(()=>this.updateDailyNameCollapsers())}async loadDailyData(e){if(!e){this.handleDailyLoadError("Выберите день, чтобы загрузить данные");return}this.selectedDayIso=e,this.setDaySelectValue(e);const t=this.dataManager.getCachedDaily(e);t?this.applyDailyData(t):this.showDailyLoadingState();try{const{data:s}=await this.dataManager.fetchDailyReport(e,{force:!!t});this.applyDailyData(s),this.announce(`Данные за ${f(e,{day:"2-digit",month:"long"})} обновлены.`)}catch(s){console.error(s),t?this.announce("Не удалось обновить данные дня"):this.handleDailyLoadError()}}openDailyModal(){if(!this.summaryDailyRevenue.length||!this.elements.dailyModal||!this.isCurrentMonth(this.selectedMonthIso))return;const e=this.elements.dailyModal.querySelector("#daily-modal-title")||document.getElementById("daily-modal-title");e&&(e.textContent="Среднедневная выручка");const t=this.getSelectedMonthLabel()||"выбранный месяц";this.elements.dailyModalSubtitle&&(this.elements.dailyModalSubtitle.textContent=`По дням за ${t.toLowerCase()}`),this.dailyRevenue=[...this.summaryDailyRevenue],this.dailyModalMode="average",this.renderDailyModalList(),this.elements.dailyModal.classList.add("visible"),this.elements.dailyModal.setAttribute("aria-hidden","false")}async openWorkModal(e){if(!e||!this.elements.dailyModal||!this.isCurrentMonth(this.selectedMonthIso))return;const t=(e.work_name||e.description||"").toString(),s=this.selectedMonthIso,a=this.dataManager&&this.dataManager.apiUrl?this.dataManager.apiUrl.replace(/\/$/,""):"/api/dashboard",n=new URL(`${a}/work-breakdown`,window.location.origin);n.searchParams.set("month",s),n.searchParams.set("work",t);try{const i=this.elements.dailyModal.querySelector("#daily-modal-title")||document.getElementById("daily-modal-title");i&&(i.textContent=`Расшифровка: ${t}`),this.elements.dailyModalSubtitle&&(this.elements.dailyModalSubtitle.textContent="");const l=await fetch(n.toString(),{headers:this.visitorTracker?this.visitorTracker.buildHeaders():{}});if(!l.ok)throw new Error("HTTP "+l.status);const r=await l.json(),d=Array.isArray(r)?r:(r==null?void 0:r.daily)||[];this.dailyModalMode="work",this.dailyRevenue=(d||[]).map(c=>{const u=c.date||c.work_date||c.day,h=c.amount??c.total_volume??c.value,m=h==null?null:Number(h),p=c.unit||"",C=c.total_amount??null;return!u||m===null||!Number.isFinite(m)?null:{date:u,amount:m,unit:p,total_amount:C}}).filter(Boolean),this.renderDailyModalList(),this.elements.dailyModal.classList.add("visible"),this.elements.dailyModal.setAttribute("aria-hidden","false")}catch(i){console.error("Ошибка загрузки расшифровки по работе:",i),N("Не удалось загрузить расшифровку по работе.","error")}}closeDailyModal(){this.elements.dailyModal&&(this.elements.dailyModal.classList.remove("visible"),this.elements.dailyModal.setAttribute("aria-hidden","true"))}renderDailyModalList(){if(!this.elements.dailyModalList||!this.elements.dailyModalEmpty)return;const e=this.getSelectedMonthLabel()||"выбранный месяц";this.elements.dailyModalSubtitle&&(this.elements.dailyModalSubtitle.textContent=`По дням за ${e.toLowerCase()}`),this.elements.dailyModalList.innerHTML="";const t=[...this.dailyRevenue].sort((i,l)=>new Date(i.date)-new Date(l.date));if(!t.length){this.elements.dailyModalEmpty.style.display="block",this.elements.dailyModalList.style.display="none";return}this.elements.dailyModalEmpty.style.display="none",this.elements.dailyModalList.style.display="grid";const s=this.dailyModalMode==="work"||t.some(i=>i.unit||i.total_amount!==null&&i.total_amount!==void 0),a=document.createElement("div");a.className="modal-row modal-row-header",s?a.innerHTML=`
          <div class="modal-row-date">Дата</div>
          <div class="modal-row-value"><span class="modal-value-number">Объем</span></div>
          <div class="modal-row-sum">Сумма,₽</div>
        `:a.innerHTML=`
          <div class="modal-row-date">Дата</div>
          <div class="modal-row-sum">Сумма, ₽</div>
        `,this.elements.dailyModalList.appendChild(a);const n=document.createDocumentFragment();t.forEach(i=>{const l=document.createElement("div");l.className="modal-row";const d=(typeof window<"u"&&window.matchMedia?window.matchMedia("(max-width: 767px)").matches:!1)?f(i.date,{day:"2-digit",month:"2-digit"}):f(i.date);if(s){const c=Number(i.amount),u=Number.isFinite(c)?c.toFixed(1):"–",h=i.unit||"",m=Number(i.total_amount),p=Number.isFinite(m)?m.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}):"–";l.innerHTML=`
          <div class="modal-row-date">${d}</div>
          <div class="modal-row-value">
            <span class="modal-value-number">${Number.isFinite(c),u}</span>
            ${h?`<span class="modal-value-unit">(${h})</span>`:""}
          </div>
          <div class="modal-row-sum">${p}</div>
        `}else{const c=Number(i.amount),u=Number.isFinite(c)?c.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}):"–";l.innerHTML=`
          <div class="modal-row-date">${d}</div>
          <div class="modal-row-sum">${u}</div>
        `}n.appendChild(l)}),this.elements.dailyModalList.appendChild(n)}renderCategories(){const e=this.dataManager.getCurrentData();if(this.elements.categoryGrid.innerHTML="",!this.groupedCategories.length){const s=e&&!e.has_data?"Данные за выбранный месяц отсутствуют":"Нет данных для отображения";this.elements.categoryGrid.innerHTML=`<div class="empty-state">${s}</div>`,this.activeCategoryKey=null,this.renderWorkList();return}const t=document.createDocumentFragment();this.groupedCategories.forEach((s,a)=>{const n=_[a%_.length],i=document.createElement("button");i.type="button",i.className=`card card--interactive category-card${s.key===this.activeCategoryKey?" active":""}`,i.style.setProperty("--accent",n.accent),i.style.setProperty("--accent-soft",n.soft);const l=typeof s.key=="string"&&s.key.toLowerCase()==="внерегламент",r=s.delta>0?"delta-positive":s.delta<0?"delta-negative":"",d=s.planned?(s.fact??0)/s.planned:null,c=d!==null&&!Number.isNaN(d)&&Number.isFinite(d),u=c?E(d):"–",h=c?Math.max(0,d*100):0,m=Math.min(115,h),p=h>100?" overflow":"",C=Math.min(120,Math.max(0,h)),$=h>100?"#16a34a":`hsl(${C}, 78%, ${h>=50?43:47}%)`,R=`width: ${m}%; --progress-color: ${$};`,F=c?Math.min(120,h).toFixed(1):"0",H=l?'<span class="category-offplan-note"><span>30% от</span><span>общего плана</span></span>':`<span class="category-pill">${s.works.length} работ</span>`;i.innerHTML=`
        <div class="category-title">
          <span>${s.title}</span>
          ${H}
        </div>
        <div class="category-values">
          <span><span class="label">План</span><strong>${y(s.planned)}</strong></span>
          <span><span class="label">Факт</span><strong>${y(s.fact)}</strong></span>
          <span><span class="label">Отклонение</span><strong class="category-delta ${r}">${y(s.delta)}</strong></span>
        </div>
        <div class="category-progress">
          <div class="category-progress-labels">
            <span>Исполнение плана</span>
            <strong>${u}</strong>
          </div>
          <div class="category-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="120" aria-valuenow="${F}">
            <div class="category-progress-fill${p}" style="${R}"></div>
          </div>
        </div>
      `,i.setAttribute("aria-pressed",s.key===this.activeCategoryKey?"true":"false"),i.addEventListener("click",()=>{this.activeCategoryKey=s.key,this.renderCategories(),this.renderWorkList()}),t.appendChild(i)}),this.elements.categoryGrid.appendChild(t),this.enhanceAccessibility()}renderWorkList(){const e=this.dataManager.getCurrentData(),t=this.groupedCategories.find(a=>a.key===this.activeCategoryKey)||null;if(this.elements.workSortSelect&&(this.elements.workSortSelect.disabled=!t),!t){this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent=e&&!e.has_data?"Данные за выбранный месяц отсутствуют":"Здесь появится список работ выбранной сметы.",this.setActiveCategoryTitle("Смета не выбрана"),this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows();return}const s=[...t.works];if(this.sortWorks(s),this.setActiveCategoryTitle(`Расшифровка работ по смете «${t.title}»`,t.title),!s.length){this.elements.workEmptyState.style.display="block",this.elements.workEmptyState.textContent="В этой смете нет строк для отображения",this.elements.workList.classList.remove("has-data"),this.workHeaderEl.hidden=!0,this.elements.workListScroller.style.display="none",this.clearWorkRows();return}this.elements.workEmptyState.style.display="none",this.elements.workList.classList.add("has-data"),this.workHeaderEl.hidden=!1,this.elements.workListScroller.style.display="block",this.renderWorkRows(s)}handleWorkSortChange(e){!e||this.workSort.column===e||(this.workSort.column=e,this.updateWorkSortButtons(),this.renderWorkList())}updateWorkSortButtons(){this.workSortButtons&&this.workSortButtons.forEach(e=>{const t=e.dataset.sort===this.workSort.column;e.classList.toggle("active",t),e.setAttribute("aria-pressed",String(t))}),this.elements.workSortSelect&&this.elements.workSortSelect.value!==this.workSort.column&&(this.elements.workSortSelect.value=this.workSort.column)}getSortValueForWork(e){if(!e)return Number.NEGATIVE_INFINITY;let t;switch(this.workSort.column){case"fact":t=e.fact_amount;break;case"delta":t=w(e);break;case"planned":default:t=e.planned_amount??e.fact_amount;break}const s=Number(t);return Number.isFinite(s)?s:Number.NEGATIVE_INFINITY}sortWorks(e){return Array.isArray(e)?this.workSort.column==="delta"?(e.sort((t,s)=>{const a=w(t),n=w(s),i=a<0,l=n<0;if(i!==l)return i?-1:1;if(i&&l){const c=a-n;if(c!==0)return c}else{const c=n-a;if(c!==0)return c}const r=((t==null?void 0:t.work_name)||(t==null?void 0:t.description)||"").toLowerCase(),d=((s==null?void 0:s.work_name)||(s==null?void 0:s.description)||"").toLowerCase();return r.localeCompare(d)}),e):(e.sort((t,s)=>{const a=this.getSortValueForWork(t),i=this.getSortValueForWork(s)-a;if(i!==0)return i;const l=((t==null?void 0:t.work_name)||(t==null?void 0:t.description)||"").toLowerCase(),r=((s==null?void 0:s.work_name)||(s==null?void 0:s.description)||"").toLowerCase();return l.localeCompare(r)}),e):e}initializeNameToggle(e){if(!e)return;const t=e.querySelector(".work-row-name-toggle");t&&(e.dataset.expanded="false",t.addEventListener("click",()=>{const s=e.classList.toggle("work-row-name--expanded");s?e.classList.remove("work-row-name--collapsed"):e.classList.add("work-row-name--collapsed"),e.dataset.expanded=String(s),t.setAttribute("aria-expanded",String(s)),t.setAttribute("aria-label",s?"Свернуть название":"Развернуть полное название")}))}updateNameCollapsers(e){if(!e)return;e.querySelectorAll(".work-row-name").forEach(s=>{const a=s.querySelector(".work-row-name-text"),n=s.querySelector(".work-row-name-toggle");if(!a||!n)return;const i=s.dataset.expanded==="true";s.classList.toggle("work-row-name--expanded",i),i?s.classList.remove("work-row-name--collapsed"):s.classList.add("work-row-name--collapsed"),n.setAttribute("aria-expanded",String(i)),n.setAttribute("aria-label",i?"Свернуть название":"Развернуть полное название"),s.classList.remove("work-row-name--collapsible"),n.hidden=!0;const l=parseFloat(window.getComputedStyle(a).lineHeight||"0"),r=l&&!Number.isNaN(l)?l*2:null;(r?a.scrollHeight>r+1:a.scrollHeight>a.offsetHeight+1)?(s.classList.add("work-row-name--collapsible"),n.hidden=!1):i||s.classList.remove("work-row-name--collapsed")})}updateDailyNameCollapsers(){this.updateNameCollapsers(this.elements.dailyTable)}createWorkRow(e,t,s){const a=e.work_name||e.description||"Без названия",n=w(e),i=n>0?"delta-positive":n<0?"delta-negative":"",l=y(e.planned_amount),r=y(e.fact_amount),d=y(n),c=document.createElement("div");return c.className="work-row",t===s-1&&c.classList.add("work-row-last"),c.innerHTML=`
      <div class="work-row-name work-row-name--collapsed" data-expanded="false">
        <span class="work-row-name-text">${a}</span>
        <button
          type="button"
          class="work-row-name-toggle"
          aria-expanded="false"
          aria-label="Развернуть полное название"
        >
          <span class="work-row-name-toggle-icon" aria-hidden="true"></span>
        </button>
      </div>
      <div class="work-row-money work-row-plan">
        <span class="work-row-label">План</span>
        <span>${l}</span>
      </div>
      <div class="work-row-money work-row-fact">
        <span class="work-row-label">Факт</span>
        <span>${r}</span>
      </div>
      <div class="work-row-delta ${i}">
        <span class="work-row-label">Отклонение</span>
        <span class="work-row-delta-value">${d}</span>
      </div>
    `,this.initializeNameToggle(c.querySelector(".work-row-name")),c.addEventListener("click",u=>{if(!u.target.closest(".work-row-name-toggle"))try{this.openWorkModal(e)}catch(h){console.error(h)}}),c}updateWorkNameCollapsers(){this.updateNameCollapsers(this.elements.workListScroller)}renderPrintReport(){const e=this.dataManager.getCurrentData(),t=this.getSelectedMonthLabel()||"–";this.elements.printMonth.textContent=t,this.elements.printUpdated.textContent=e&&e.has_data?T(e.last_updated):"нет данных",this.elements.printSubtitle.textContent=e&&e.has_data?"Выгружены все строки со статусом «Рассмотрено»":"Данные по выбранному месяцу отсутствуют",this.elements.printBody.innerHTML="";const s=document.createDocumentFragment();if(!e||!this.groupedCategories.length){const l=document.createElement("tr");l.innerHTML='<td colspan="5" style="text-align:center; font-style: italic;">Нет данных для печати</td>',s.appendChild(l),this.elements.printBody.appendChild(s),this.elements.printTotalPlan.textContent="–",this.elements.printTotalFact.textContent="–",this.elements.printTotalDelta.textContent="–",this.elements.printTotalDelta.classList.remove("delta-positive","delta-negative");return}let a=0,n=0,i=0;this.groupedCategories.forEach(l=>{const r=l.delta??l.fact-l.planned,d=document.createElement("tr"),c=r>0?"delta-positive":r<0?"delta-negative":"";d.className="print-smeta-summary",d.innerHTML=`
        <td>${l.title}</td>
        <td>Итого по смете</td>
        <td class="num">${g(l.planned)}</td>
        <td class="num">${g(l.fact)}</td>
        <td class="num ${c}">${g(r)}</td>
      `,s.appendChild(d),l.works.forEach(u=>{const h=w(u),m=h>0?"delta-positive":h<0?"delta-negative":"",p=document.createElement("tr");p.innerHTML=`
          <td></td>
          <td>${u.work_name||u.description||"Без названия"}</td>
          <td class="num">${g(u.planned_amount)}</td>
          <td class="num">${g(u.fact_amount)}</td>
          <td class="num ${m}">${g(h)}</td>
        `,s.appendChild(p)}),a+=l.planned??0,n+=l.fact??0,i+=r??0}),this.elements.printBody.appendChild(s),this.elements.printTotalPlan.textContent=g(a),this.elements.printTotalFact.textContent=g(n),this.elements.printTotalDelta.textContent=g(i),this.elements.printTotalDelta.classList.remove("delta-positive","delta-negative"),i>0&&this.elements.printTotalDelta.classList.add("delta-positive"),i<0&&this.elements.printTotalDelta.classList.add("delta-negative")}getSelectedMonthLabel(){const e=this.elements.monthSelect.options[this.elements.monthSelect.selectedIndex];return e?e.textContent.trim():""}async downloadPdfReport(e){if(e.preventDefault(),this.elements.pdfButton.disabled)return;const s=(this.getSelectedMonthLabel()||this.elements.monthSelect.value||"period").toString().trim().replace(/\s+/g,"-").replace(/[^0-9A-Za-zА-Яа-я\-]+/g,"").replace(/-+/g,"-").replace(/^-|-$/g,""),a=s?`mad-podolsk-otchet-${s}.pdf`:"mad-podolsk-otchet.pdf";this.elements.pdfButton.disabled=!0,this.elements.pdfButton.innerHTML="Формируем PDF…";try{const n=new URL(this.apiPdfUrl,window.location.origin);n.searchParams.set("month",this.elements.monthSelect.value);const i=await fetch(n.toString(),{headers:{Accept:"application/pdf",...this.visitorTracker?this.visitorTracker.buildHeaders():{}}});if(!i.ok)throw new Error("HTTP "+i.status);const l=await i.blob(),r=URL.createObjectURL(l),d=document.createElement("a");d.href=r,d.download=a,d.style.display="none",document.body.appendChild(d),d.click(),d.remove(),setTimeout(()=>URL.revokeObjectURL(r),0),this.announce("PDF-отчёт сформирован.")}catch(n){console.error("PDF export error",n),N("Не удалось сформировать PDF. Попробуйте ещё раз позже.","error"),this.announce("Ошибка формирования PDF")}finally{this.elements.pdfButton.innerHTML=this.pdfButtonDefaultLabel,this.elements.pdfButton.disabled=!this.groupedCategories.length}}enhanceAccessibility(){this.elements.categoryGrid.querySelectorAll(".category-card").forEach((t,s)=>{var n,i;const a=((i=(n=t.querySelector(".category-title span"))==null?void 0:n.textContent)==null?void 0:i.trim())||`Смета ${s+1}`;t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.setAttribute("aria-label",`Смета ${a}`),t.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),t.click())})})}createLiveRegion(){const e=document.createElement("div");return e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",document.body.appendChild(e),e}announce(e){this.liveRegion&&(this.liveRegion.textContent="",requestAnimationFrame(()=>{this.liveRegion.textContent=e}))}}function P(){if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();const o=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return o()+o()+"-"+o()+"-"+o()+"-"+o()+"-"+o()+o()+o()}function L(o,e){try{return o.getItem(e)}catch(t){return console.warn("Не удалось прочитать из хранилища",e,t),null}}function M(o,e,t){try{o.setItem(e,t)}catch(s){console.warn("Не удалось сохранить в хранилище",e,s)}}function U(o,e,{days:t=365}={}){try{const s=Math.max(1,Math.floor(t*24*60*60));document.cookie=`${o}=${encodeURIComponent(e)}; path=/; max-age=${s}`}catch(s){console.warn("Не удалось сохранить cookie",o,s)}}class J{constructor({userKey:e="mad_user_id",sessionKey:t="mad_session_id",sessionStartedAtKey:s="mad_session_started_at",visitLoggedKey:a="mad_visit_logged"}={}){this.userKey=e,this.sessionKey=t,this.sessionStartedAtKey=s,this.visitLoggedKey=a,this.userId=this.restoreUserId(),this.sessionId=this.restoreSessionId(),this.sessionStartedAt=this.restoreSessionStart(),this.visitLogged=this.restoreVisitLogged()}restoreUserId(){const t=(L(localStorage,this.userKey)||this.getCookieValue(this.userKey)||P()).trim();return M(localStorage,this.userKey,t),U(this.userKey,t,{days:365}),t}restoreSessionId(){const t=(L(sessionStorage,this.sessionKey)||this.getCookieValue(this.sessionKey)||P()).trim();return M(sessionStorage,this.sessionKey,t),U(this.sessionKey,t,{days:1}),t}restoreSessionStart(){const t=v(L(sessionStorage,this.sessionStartedAtKey))??Date.now();return M(sessionStorage,this.sessionStartedAtKey,String(t)),t}restoreVisitLogged(){return L(sessionStorage,this.visitLoggedKey)==="1"}getCookieValue(e){const t=document.cookie.match(new RegExp(`(?:^|; )${e}=([^;]*)`));return t?decodeURIComponent(t[1]):null}getSessionDurationSec(){const e=Date.now()-this.sessionStartedAt;return e>0?Math.round(e/1e3):0}buildHeaders(){const e={};this.userId&&(e["X-User-Id"]=this.userId),this.sessionId&&(e["X-Session-Id"]=this.sessionId);const t=this.getSessionDurationSec();return Number.isFinite(t)&&(e["X-Session-Duration-Sec"]=String(t)),e}markVisitLogged(){this.visitLogged=!0,M(sessionStorage,this.visitLoggedKey,"1")}async sendVisitLog({apiBase:e,endpoint:t}){if(!e||!t||this.visitLogged)return;const s={endpoint:t,user_id:this.userId,session_id:this.sessionId,session_duration_sec:this.getSessionDurationSec()};try{await fetch(`${e}/visit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),keepalive:!0}),this.markVisitLogged()}catch(a){console.warn("Не удалось отправить статистику визита",a)}}}const A=(()=>{const o=document.querySelector('meta[name="mad-api-url"]');return((o==null?void 0:o.content)||window.MAD_API_URL||"").trim()||"/api/dashboard"})(),b=A.replace(/\/$/,""),Q=`${b}/pdf`,Z=`${b}/months`,ee=`${b}/days`,te=`${b}/daily`;document.addEventListener("DOMContentLoaded",()=>{const o=new J,e=B({page:".page",monthSelect:"#month",daySelect:"#day",monthControls:"#month-controls",dayControls:"#day-controls",lastUpdatedText:"#last-updated-text",lastUpdatedTextDaily:"#last-updated-text-daily",sumPlanned:"#sum-planned",sumFact:"#sum-fact",sumDelta:"#sum-delta",sumFactProgress:"#sum-fact-progress",sumFactProgressLabel:"#sum-fact-progress-label",sumDailyAverage:"#sum-daily-average",dailyAverageNote:"#daily-average-note",dailyAverageHint:"#daily-average-hint",dailyAverageCard:"#daily-average-card",dailyModal:"#daily-modal",dailyModalClose:"#daily-modal-close",dailyModalList:"#daily-modal-list",dailyModalEmpty:"#daily-modal-empty",dailyModalSubtitle:"#daily-modal-subtitle",summaryGrid:"#summary-grid",summarySkeleton:"#summary-skeleton",categoryGrid:"#category-grid",categorySkeleton:"#category-skeleton",workList:"#work-list",workSkeleton:"#work-skeleton",workEmptyState:"#work-empty-state",workSortSelect:"#work-sort-select",activeCategoryTitle:"#active-category-title",activeCategoryTitleDesktop:"#active-category-title-desktop",activeCategoryTitleMobileValue:"#active-category-title-mobile-value",workDetailHint:"#work-detail-hint",printMonth:"#print-month",printUpdated:"#print-updated",printBody:"#print-report-body",printTotalPlan:"#print-total-plan",printTotalFact:"#print-total-fact",printTotalDelta:"#print-total-delta",printSubtitle:"#print-subtitle",pdfButton:"#download-pdf",pdfButtonContainerDesktop:".pdf-action-desktop",pdfButtonContainerMobile:".pdf-action-mobile",contractCard:"#contract-card",contractAmount:"#contract-amount",contractExecuted:"#contract-executed",contractPercent:"#contract-percent",contractProgress:"#contract-progress",contractTitleDate:"#contract-title-date",viewModeMonthly:"#tab-monthly",viewModeDaily:"#tab-daily",dailyPanel:"#daily-panel",dailySkeleton:"#daily-skeleton",dailyEmptyState:"#daily-empty-state",dailyTable:"#daily-table",dailyPanelTitle:"#daily-panel-title",dailyPanelSubtitle:"#daily-panel-subtitle"}),t=e.pdfButton?e.pdfButton.innerHTML:"Скачать PDF";K({pdfButton:e.pdfButton,workSortSelect:e.workSortSelect},!0);const s=window.matchMedia("(max-width: 767px)"),a=r=>{if(!e.pdfButton||!e.pdfButtonContainerDesktop||!e.pdfButtonContainerMobile)return;const d=r?e.pdfButtonContainerMobile:e.pdfButtonContainerDesktop;e.pdfButton.parentElement!==d&&d.appendChild(e.pdfButton)};a(s.matches),s.addEventListener("change",r=>a(r.matches));const n=new Y(A,{monthsUrl:Z,daysUrl:ee,dailyUrl:te,visitorTracker:o});new X({dataManager:n,elements:e,apiPdfUrl:Q,pdfButtonDefaultLabel:t,visitorTracker:o}).init();const l=new URL(A,window.location.origin).pathname;o.sendVisitLog({apiBase:b,endpoint:l})});
